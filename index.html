
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymBro - AI Workout Logger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #000000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background-color: #000000;
            border-bottom: 1px solid #27272a;
        }

        .header h1 {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }

        .header-btn {
            background: none;
            border: none;
            color: #f86b06;
            font-weight: bold;
            cursor: pointer;
            padding: 8px;
            min-width: 70px;
        }

        .header-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            padding-bottom: 100px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: #18181b;
            padding: 24px;
            border-radius: 12px;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #a1a1aa;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .btn {
            background-color: #f86b06;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .btn-secondary {
            background-color: #18181b;
            color: white;
        }

        .btn-danger {
            background-color: #dc2626;
        }
        
        .btn-icon {
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 8px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .workout-card {
            background-color: #18181b;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
        }
        
        .workout-card .actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .workout-card:hover {
            background-color: #27272a;
        }

        .workout-icon {
            width: 48px;
            height: 48px;
            background-color: #27272a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .workout-info {
           overflow: hidden;
           flex: 1;
        }

        .workout-info h3 {
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .workout-info p {
            font-size: 14px;
            color: #a1a1aa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #27272a;
            border-radius: 8px;
            background-color: #18181b;
            color: white;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #f86b06;
        }
        
        .exercise-builder-card {
            background-color: #18181b;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .exercise-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .exercise-builder-header h4 {
            font-size: 18px;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 4px;
            font-size: 24px;
        }
        
        .series-list .series-header, .series-list .series-item {
            display: grid;
            grid-template-columns: 30px 1fr 1fr auto;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }
        .series-list .series-header span {
            font-size: 12px;
            color: #a1a1aa;
            text-align: center;
        }
        .series-list .series-item-label {
            font-weight: bold;
            color: #a1a1aa;
        }
        
        .series-list .series-input {
            width: 100%;
            padding: 8px;
        }

        .tabs {
            display: flex;
            background-color: #18181b;
            border-radius: 24px;
            padding: 4px;
            margin-bottom: 24px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            background: none;
            border: none;
            color: #a1a1aa;
        }

        .tab.active {
            background-color: #f86b06;
            color: white;
        }
        
        .upload-area {
            border: 2px dashed #27272a;
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            margin: 24px 0;
            cursor: pointer;
        }

        .upload-area:hover { border-color: #f86b06; }
        .upload-area.loading { border-color: #f86b06; }
        
        .spinner {
            border: 2px solid #27272a;
            border-top: 2px solid #f86b06;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background-color: #000000;
            border-top: 1px solid #27272a;
            padding: 12px 16px 24px;
            transition: transform 0.3s ease-in-out;
        }

        .bottom-nav.hidden {
            transform: translate(-50%, 100%);
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: #71717a;
            text-decoration: none;
            padding: 8px;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item.active {
            color: #f86b06;
        }
        
        .nav-item svg {
            width: 24px;
            height: 24px;
            stroke: #71717a;
            stroke-width: 1.5;
            fill: none;
            transition: stroke 0.2s ease-in-out;
        }

        .nav-item.active svg {
            stroke: #f86b06;
        }

        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        .error-message {
            background-color: #dc2626;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .hidden {
            display: none !important;
        }

        .timer {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 24px 0;
            font-family: 'Courier New', monospace;
        }

        .live-workout-card {
            background-color: #18181b;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        
        .live-exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .live-exercise-header-info { flex: 1; overflow: hidden; }
        .live-exercise-header-actions { display: flex; gap: 8px; flex-shrink: 0; }

        .set-item {
            background-color: #27272a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .set-item-main {
             display: grid;
             grid-template-columns: 1fr auto auto;
             align-items: center;
             gap: 12px;
        }

        .set-item.completed { background-color: #16a34a; opacity: 0.8; }
        .set-item.current { border: 2px solid white; }
        .set-item.disabled { pointer-events: none; opacity: 0.6; }
        .set-item .set-info h4 { margin-bottom: 4px; }
        .set-item .set-info p { font-size: 12px; color: #a1a1aa; }
        .set-item .set-input-group { display: flex; align-items: center; gap: 4px; color: #a1a1aa; }

        .set-item .set-input {
            width: 60px;
            padding: 8px;
            border: 1px solid #71717a;
            border-radius: 6px;
            background-color: #18181b;
            color: white;
            text-align: center;
            font-size: 14px;
        }

        .set-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .set-actions .note-btn {
            background: none; border: none; color: #a1a1aa; font-size: 20px; cursor: pointer;
        }

        .set-actions .complete-btn {
            width: 32px; height: 32px; border: 2px solid #71717a; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; background: none; cursor: pointer; color: white; font-size: 20px;
        }
        
        .set-item.completed .complete-btn { background-color: #16a34a; border-color: #16a34a; }
        
        .set-note-input {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            font-size: 12px;
            background-color: #27272a;
            border: 1px solid #71717a;
            border-radius: 6px;
            color: white;
        }

        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 16px;
        }

        .modal-content {
            background-color: #18181b;
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .modal-header h3 { font-size: 20px; }

        .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        
        #rest-timer-display { font-size: 64px; font-weight: bold; text-align: center; margin: 32px 0; font-family: 'Courier New', monospace; }
        #exercise-picker-list .workout-card.completed { background-color: #166534; }
        #exercise-picker-list .workout-card.completed .workout-info h3 { text-decoration: line-through; opacity: 0.7; }

        /* Light Mode Styles */
        body.light-mode {
            background-color: #f0f2f5;
            color: #18181b;
        }
        .light-mode .app-container, .light-mode .header, .light-mode .bottom-nav {
            background-color: #ffffff;
            border-color: #e5e7eb;
        }
        .light-mode .header h1 {
            color: #18181b;
        }
        .light-mode .stat-card, .light-mode .workout-card, .light-mode .exercise-builder-card,
        .light-mode .live-workout-card, .light-mode .modal-content, .light-mode .tabs {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
        }
        .light-mode .stat-card h3, .light-mode .workout-info p, .light-mode .series-list .series-header span,
        .light-mode .series-list .series-item-label, .light-mode .nav-item, .light-mode .set-item .set-info p,
        .light-mode .set-actions .note-btn {
            color: #6b7280;
        }
        .light-mode .workout-card:hover {
            background-color: #f9fafb;
        }
        .light-mode .workout-icon, .light-mode .set-item, .light-mode .btn-secondary {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .light-mode .form-input, .light-mode .set-item .set-input {
            background-color: #f9fafb;
            color: #18181b;
            border-color: #d1d5db;
        }
        .light-mode .form-input:focus, .light-mode .set-item .set-input:focus {
            border-color: #f86b06;
        }
        .light-mode .tab {
            color: #6b7280;
        }
        .light-mode .nav-item svg {
            stroke: #6b7280;
        }
        .light-mode .nav-item.active, .light-mode .nav-item.active svg {
            color: #f86b06;
            stroke: #f86b06;
        }
         .light-mode .set-item.current {
            border: 2px solid #374151;
        }
        .light-mode .close-btn {
            color: #374151;
        }
        .light-mode .header-btn {
            color: #f86b06;
        }
    </style>
</head>
<body class="">
    <div class="app-container">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <div class="header">
                <div style="width: 70px;"></div>
                <h1>GymBro</h1>
                <button class="header-btn" id="theme-toggle-btn" onclick="toggleTheme()" style="font-size: 24px; min-width: 70px;">☀️</button>
            </div>
            <div class="content">
                <h2 style="margin-bottom: 16px; font-size: 22px;">Statistiche</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Workout totali</h3><div class="value" id="total-workouts">0</div></div>
                    <div class="stat-card"><h3>Questa settimana</h3><div class="value" id="week-workouts">0</div></div>
                </div>
                <h2 style="margin-bottom: 16px; font-size: 22px;">Azioni rapide</h2>
                <button class="btn" onclick="showScreen('workout-screen')">Aggiungi workout</button>
                <h2 style="margin-bottom: 16px; font-size: 22px;">Workout recenti</h2>
                <div id="recent-workouts"></div>
            </div>
        </div>

        <!-- Workout Screen -->
        <div id="workout-screen" class="screen">
            <div class="header">
                <button class="header-btn" onclick="goBack()">← Indietro</button>
                <h1 id="workout-form-title">Crea workout</h1>
                <button class="header-btn" id="save-workout-btn" onclick="saveOrUpdateWorkout()">Salva</button>
            </div>
            <div class="content">
                <div class="tabs">
                    <button class="tab active" onclick="setWorkoutTab('manual')">Manuale</button>
                    <button class="tab" onclick="setWorkoutTab('scan')">Scansione AI</button>
                </div>
                
                <div id="manual-tab">
                    <div class="form-group">
                        <label>Nome workout</label>
                        <input type="text" class="form-input" id="workout-name" placeholder="es. Sessione di forza">
                    </div>
                    <h3 style="margin: 24px 0 16px;">Esercizi</h3>
                    <div id="exercise-list-builder"></div>
                    <div style="display: flex; gap: 10px; margin-top: 16px;">
                        <input type="text" class="form-input" id="new-exercise-name" placeholder="Nome nuovo esercizio">
                        <button class="btn btn-secondary" onclick="addExerciseToBuilder()" style="width: auto; margin-bottom: 0; flex-shrink: 0;">Aggiungi</button>
                    </div>
                </div>

                <div id="scan-tab" class="hidden">
                    <h3 style="text-align: center; margin-bottom: 16px;">Carica o scatta una foto del tuo workout</h3>
                    <div class="upload-area" id="upload-area" onclick="triggerFileInput()">
                        <div id="upload-content"><p>Clicca per caricare</p></div>
                    </div>
                    <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <div id="scan-error" class="error-message hidden"></div>
                </div>
            </div>
        </div>
        
        <!-- My Workouts Screen -->
        <div id="my-workouts-screen" class="screen">
            <div class="header"><button class="header-btn" onclick="showScreen('home-screen')">← Indietro</button><h1>Workout</h1><div style="width: 70px;"></div></div>
            <div class="content"><div id="my-workouts-list"></div></div>
        </div>

        <!-- Diary Screen -->
        <div id="diary-screen" class="screen">
            <div class="header"><button class="header-btn" onclick="showScreen('home-screen')">← Indietro</button><h1>Diario</h1><div style="width: 70px;"></div></div>
            <div class="content"><div id="workout-history"></div></div>
        </div>

        <!-- Workout Detail Screen -->
        <div id="detail-screen" class="screen">
            <div class="header"><button class="header-btn" onclick="goBack()">← Indietro</button><h1>Dettagli workout</h1><button class="header-btn" id="start-workout-btn" onclick="startLiveWorkout()">Inizia</button></div>
            <div class="content"><div id="workout-detail-content"></div></div>
        </div>

        <!-- Live Workout Screen -->
        <div id="live-screen" class="screen">
            <div class="header"><button class="header-btn" onclick="endLiveWorkout()">Termina</button><h1>Workout Live</h1><div style="width: 70px;"></div></div>
            <div class="content">
                <div style="text-align: center; margin-bottom: 24px;"><p style="color: #a1a1aa; margin-bottom: 8px;" id="live-workout-name"></p><div class="timer" id="workout-timer">00:00:00</div></div>
                <div class="live-workout-card">
                    <div class="live-exercise-header">
                        <div class="live-exercise-header-info"><p style="color: #a1a1aa; font-size: 12px; margin-bottom: 4px;">ESERCIZIO CORRENTE</p><h3 id="current-exercise-name"></h3></div>
                        <div class="live-exercise-header-actions">
                             <button class="btn btn-secondary" onclick="showEditExerciseModal()" style="width: auto; margin: 0; padding: 8px 12px;">Mod.</button>
                             <button class="btn btn-secondary" onclick="showExercisePicker()" style="width: auto; margin: 0; padding: 8px 12px;">Cambia</button>
                        </div>
                    </div>
                    <p style="color: #a1a1aa; font-size: 14px; margin-bottom: 16px;" id="exercise-progress"></p>
                    <div id="sets-container"></div>
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="previousSet()" id="prev-btn">Precedente</button>
                    <button class="btn" onclick="nextSet(true)" id="next-btn">Successivo</button>
                </div>
                <button class="btn" onclick="finishWorkout()">Fine & Salva Workout</button>
            </div>
        </div>

        <!-- Modals -->
        <div id="exercise-picker-modal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h3>Cambia Esercizio</h3><button class="close-btn" onclick="hideExercisePicker()">×</button></div><div id="exercise-picker-list"></div></div></div>
        <div id="rest-timer-modal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h3>Recupero</h3><button class="close-btn" onclick="skipRest()">×</button></div><div id="rest-timer-display">01:00</div><p style="text-align: center; color: #a1a1aa;">Prossima: <span id="next-up-info">Serie 2</span></p><button class="btn" onclick="skipRest()" style="margin-top: 24px;">Salta Recupero</button></div></div>
        <div id="edit-exercise-modal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h3>Modifica Esercizio</h3><button class="close-btn" onclick="hideEditExerciseModal()">×</button></div><div class="form-group"><label>Nome Esercizio</label><input type="text" class="form-input" id="modal-exercise-name"></div><div class="form-group"><label>Recupero (s)</label><input type="number" class="form-input" id="modal-exercise-rest"></div><button class="btn" onclick="saveLiveExerciseChanges()">Salva Modifiche</button></div></div>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-items">
                <a href="#" class="nav-item active" onclick="showScreen('home-screen')"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span>Home</span></a>
                <a href="#" class="nav-item" onclick="showScreen('my-workouts-screen')"><svg viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="m9 14 2 2 4-4"></path></svg><span>Workout</span></a>
                <a href="#" class="nav-item" onclick="showScreen('workout-screen')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg><span>Aggiungi</span></a>
                <a href="#" class="nav-item" onclick="showScreen('diary-screen')"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>Diario</span></a>
            </div>
        </div>
    </div>

    <script>
        // DATA STRUCTURE:
        // workout = { id, name, isTemplate, exercises: [ { name, note, rest, series: [ {reps, weight, note}, ... ] } ] }
        // completedWorkout = { ...workout, date, duration, performance: {'exIdx-setIdx': {reps, weight, note}} }
        
        const DB_KEY = 'GymBro_workouts_it_v2';
        const THEME_KEY = 'GymBro_theme_it';
        const GEMINI_API_KEY = 'AIzaSyAipeUNqXwvgZDOM9L2I602ARsw5jaGxKg';
        let workouts = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
        let currentWorkout = null, editingWorkoutId = null; 
        let currentExerciseIndex = 0, currentSetIndex = 0;
        let performanceData = {}; 
        let workoutStartTime = null;
        let timerInterval = null, restTimerInterval = null;
        let isResting = false;
        let currentScreen = 'home-screen', previousScreen = 'home-screen';
        let restAudio = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            updateAllScreens();
            initializeAudio();
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
            setTheme(savedTheme);
        }

        function setTheme(theme) {
            const body = document.body;
            const toggleBtn = document.getElementById('theme-toggle-btn');
            if (theme === 'light') {
                body.classList.add('light-mode');
                toggleBtn.innerHTML = '🌙';
            } else {
                body.classList.remove('light-mode');
                toggleBtn.innerHTML = '☀️';
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            localStorage.setItem(THEME_KEY, newTheme);
        }
        
        function initializeAudio() {
    try {
        // Crea un beep audio sintetizzato
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const createBeep = (frequency, duration) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        };
        
        restAudio = {
            play: () => {
                // Suona 3 beep consecutivi
                createBeep(800, 0.2);
                setTimeout(() => createBeep(800, 0.2), 300);
                setTimeout(() => createBeep(1000, 0.4), 600);
            }
        };
    } catch (error) {
        console.log('Audio non supportato:', error);
        restAudio = { play: () => {} }; // Fallback silenzioso
    }
}

function updateAllScreens() {
            updateStats();
            renderRecentWorkouts();
            renderWorkoutHistory();
            renderMyWorkouts();
        }

        function showScreen(screenId) {
            if (screenId === currentScreen && screenId !== 'workout-screen') return;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.getAttribute('onclick').includes(screenId)));
            if (screenId === 'workout-screen' && !editingWorkoutId) resetWorkoutForm();
            document.querySelector('.bottom-nav').classList.toggle('hidden', screenId === 'live-screen');
            previousScreen = currentScreen;
            currentScreen = screenId;
        }

        function goBack() {
            if (currentScreen === 'workout-screen' && editingWorkoutId) resetWorkoutForm();
            showScreen(previousScreen);
        }
        
        function setWorkoutTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
            
            document.getElementById('manual-tab').classList.toggle('hidden', tab !== 'manual');
            document.getElementById('scan-tab').classList.toggle('hidden', tab !== 'scan');
            document.getElementById('save-workout-btn').style.display = (tab === 'manual') ? 'block' : 'none';
        }

        function updateStats() {
            const completed = workouts.filter(w => !w.isTemplate);
            const weekStart = new Date(); weekStart.setDate(weekStart.getDate() - 7);
            document.getElementById('total-workouts').textContent = completed.length;
            document.getElementById('week-workouts').textContent = completed.filter(w => new Date(w.date) >= weekStart).length;
        }

        function renderRecentWorkouts() {
            const container = document.getElementById('recent-workouts');
            const recent = workouts.filter(w => !w.isTemplate).slice(0, 5);
            if (recent.length === 0) { container.innerHTML = '<p style="text-align: center; color: #a1a1aa; padding: 24px;">Nessun allenamento recente.</p>'; return; }
            container.innerHTML = recent.map(w => `
                <div class="workout-card" onclick="showWorkoutDetail('${w.id}')">
                    <div class="workout-icon">💪</div>
                    <div class="workout-info">
                        <h3>${w.name}</h3>
                        <p>${w.exercises.length} esercizi • ${w.duration || 'N/D'} min</p>
                    </div>
                    <div class="actions">
                        <button class="btn btn-icon" onclick="event.stopPropagation(); startWorkoutFromHome('${w.id}')" style="width: auto; margin: 0; padding: 8px 16px;">Inizia</button>
                        <button class="btn btn-danger" onclick="event.stopPropagation(); deleteCompletedWorkout('${w.id}')" style="width: auto; margin: 0; padding: 8px 12px;">X</button>
                    </div>
                </div>`).join('');
        }
        
        function renderMyWorkouts() {
            const container = document.getElementById('my-workouts-list');
            const templates = workouts.filter(w => w.isTemplate);
            if (templates.length === 0) { container.innerHTML = '<p style="text-align: center; color: #a1a1aa; padding: 24px;">Nessun workout salvato.</p>'; return; }
            container.innerHTML = templates.map(w => `<div class="workout-card"><div class="workout-icon" onclick="showWorkoutDetail('${w.id}')">💪</div><div class="workout-info" onclick="showWorkoutDetail('${w.id}')"><h3>${w.name}</h3><p>${w.exercises.length} es, ${w.exercises.reduce((a, ex) => a + ex.series.length, 0)} serie</p></div><div class="actions"><button class="btn btn-secondary btn-icon" onclick="startWorkoutFromHome('${w.id}')" style="width: auto; margin: 0; padding: 8px 12px;">▶</button><button class="btn btn-secondary" onclick="editWorkout('${w.id}')" style="width: auto; margin: 0; padding: 8px 12px;">Mod.</button><button class="btn btn-danger" onclick="deleteWorkout('${w.id}')" style="width: auto; margin: 0; padding: 8px 12px;">X</button></div></div>`).join('');
        }
        
        function editWorkout(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) return;
            editingWorkoutId = workoutId;
            showScreen('workout-screen');
            setWorkoutTab('manual');
            document.getElementById('workout-form-title').textContent = 'Modifica workout';
            document.getElementById('workout-name').value = workout.name;
            renderExerciseBuilder(workout.exercises);
        }
        
        function deleteWorkout(workoutId) {
            if (confirm('Sei sicuro di voler eliminare questo modello di workout?')) {
                workouts = workouts.filter(w => w.id !== workoutId);
                localStorage.setItem(DB_KEY, JSON.stringify(workouts));
                updateAllScreens();
                if (currentScreen === 'my-workouts-screen') renderMyWorkouts();
            }
        }

        function deleteCompletedWorkout(workoutId) {
            if (confirm('Sei sicuro di voler eliminare questo workout completato? L\'azione è irreversibile.')) {
                workouts = workouts.filter(w => w.id !== workoutId);
                localStorage.setItem(DB_KEY, JSON.stringify(workouts));
                updateAllScreens();
            }
        }

        function renderWorkoutHistory() {
            const container = document.getElementById('workout-history');
            const completed = workouts.filter(w => !w.isTemplate).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (completed.length === 0) { container.innerHTML = '<p style="text-align: center; color: #a1a1aa; padding: 24px;">Nessuno storico trovato.</p>'; return; }
            const grouped = completed.reduce((acc, w) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const y = new Date(today); y.setDate(today.getDate() - 1);
                const d = new Date(w.date); d.setHours(0,0,0,0);
                let key = (d.getTime() === today.getTime()) ? 'Oggi' : (d.getTime() === y.getTime()) ? 'Ieri' : d.toLocaleDateString('it-IT', {year: 'numeric', month: 'long', day: 'numeric'});
                if (!acc[key]) acc[key] = []; acc[key].push(w); return acc;
            }, {});
            container.innerHTML = Object.entries(grouped).map(([date, wList]) => `
                <div style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 12px; font-size: 18px;">${date}</h3>
                    ${wList.map(w => `
                        <div class="workout-card" onclick="showWorkoutDetail('${w.id}')">
                            <div class="workout-icon">💪</div>
                            <div class="workout-info">
                                <h3>${w.name}</h3>
                                <p>${new Date(w.date).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})} • ${w.duration} min</p>
                            </div>
                            <div class="actions">
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteCompletedWorkout('${w.id}')" style="width: auto; margin: 0; padding: 8px 12px;">X</button>
                            </div>
                        </div>`).join('')}
                </div>`).join('');
        }

        function addExerciseToBuilder() {
            const nameInput = document.getElementById('new-exercise-name');
            const name = nameInput.value.trim();
            if (!name) { alert('Inserisci un nome per l\'esercizio.'); return; }
            const exercises = getExercisesFromBuilder();
            exercises.push({ name, note: '', rest: 60, series: [] });
            renderExerciseBuilder(exercises);
            nameInput.value = '';
        }

        function renderExerciseBuilder(exercises) {
            const container = document.getElementById('exercise-list-builder');
            if (!exercises || exercises.length === 0) { container.innerHTML = '<p style="text-align: center; color: #a1a1aa; padding: 16px;">Nessun esercizio aggiunto.</p>'; return; }
            container.innerHTML = exercises.map((ex, exIdx) => `
                <div class="exercise-builder-card" data-ex-index="${exIdx}">
                    <div class="exercise-builder-header"><h4>${ex.name}</h4><button class="remove-btn" onclick="removeExerciseFromBuilder(${exIdx})">×</button></div>
                    <div class="form-group"><input type="text" class="form-input" placeholder="Note (opzionale)" value="${ex.note || ''}"></div>
                    <div class="form-group"><label>Recupero (secondi)</label><input type="number" class="form-input" value="${ex.rest || 60}"></div>
                    <div class="series-list">
                        <div class="series-header"><span></span><span>Rep</span><span>kg</span><span></span></div>
                        ${(ex.series || []).map((serie, sIdx) => `
                            <div class="series-item">
                                <span class="series-item-label">${sIdx + 1}.</span>
                                <input type="number" class="form-input series-input" placeholder="Rep" value="${serie.reps}">
                                <input type="number" class="form-input series-input" placeholder="kg" value="${serie.weight}">
                                <button class="remove-btn" style="font-size: 20px;" onclick="removeSerieFromBuilder(${exIdx}, ${sIdx})">×</button>
                            </div>`).join('')}
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 12px; margin-bottom: 0;" onclick="addSerieToBuilder(${exIdx})">Aggiungi Serie</button>
                </div>`).join('');
        }
        
        function getExercisesFromBuilder() {
            return Array.from(document.querySelectorAll('#exercise-list-builder .exercise-builder-card')).map(card => ({
                name: card.querySelector('h4').textContent,
                note: card.querySelector('input[placeholder*="Note"]').value,
                rest: parseInt(card.querySelector('input[type="number"][value]').value) || 60,
                series: Array.from(card.querySelectorAll('.series-item')).map(item => ({
                    reps: parseInt(item.querySelectorAll('input')[0].value) || 0,
                    weight: parseFloat(item.querySelectorAll('input')[1].value) || 0,
                    note: ''
                }))
            }));
        }
        
        function addSerieToBuilder(exIdx) {
            const exercises = getExercisesFromBuilder();
            const lastSerie = exercises[exIdx].series.slice(-1)[0] || {reps: 8, weight: 0, note: ''};
            exercises[exIdx].series.push({...lastSerie});
            renderExerciseBuilder(exercises);
        }

        function removeExerciseFromBuilder(exIdx) { renderExerciseBuilder(getExercisesFromBuilder().filter((_, i) => i !== exIdx)); }
        function removeSerieFromBuilder(exIdx, sIdx) { let e = getExercisesFromBuilder(); e[exIdx].series.splice(sIdx, 1); renderExerciseBuilder(e); }

        function resetWorkoutForm() {
            editingWorkoutId = null;
            document.getElementById('workout-form-title').textContent = 'Crea workout';
            document.getElementById('workout-name').value = '';
            renderExerciseBuilder([]);
            setWorkoutTab('manual');
        }

        function saveOrUpdateWorkout() {
            const name = document.getElementById('workout-name').value.trim();
            const exercises = getExercisesFromBuilder();
            if (!name || exercises.length === 0) { alert('Inserisci un nome e almeno un esercizio.'); return; }
            if (exercises.some(ex => ex.series.length === 0)) { alert('Tutti gli esercizi devono avere almeno una serie.'); return; }

            const newWorkout = { name, exercises, isTemplate: true, type: 'Forza' };
            if (editingWorkoutId) {
                const index = workouts.findIndex(w => w.id === editingWorkoutId);
                if (index > -1) workouts[index] = { ...workouts[index], ...newWorkout };
            } else {
                workouts.unshift({ ...newWorkout, id: Date.now().toString() });
            }
            localStorage.setItem(DB_KEY, JSON.stringify(workouts));
            resetWorkoutForm();
            updateAllScreens();
            showScreen('my-workouts-screen');
        }

        function showWorkoutDetail(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) return;
            currentWorkout = workout;
            const isTemplate = workout.isTemplate;
            document.getElementById('workout-detail-content').innerHTML = `
                <h2 style="margin-bottom: 16px; font-size: 22px;">Riepilogo</h2>
                <div class="workout-card"><div class="workout-icon">💪</div><div class="workout-info"><h3>${workout.name}</h3><p>${workout.type}</p></div></div>
                ${!isTemplate ? `<div class="workout-card"><div class="workout-icon">⏱️</div><div class="workout-info"><h3>Durata</h3><p>${workout.duration} minuti</p></div></div>` : ''}
                <h2 style="margin: 24px 0 16px; font-size: 22px;">Esercizi</h2>
                ${workout.exercises.map(ex => `<div class="workout-card" style="flex-direction:column; align-items:start;"><div class="workout-info" style="width:100%"><h3>${ex.name}</h3><p>${ex.note||''}</p></div><div style="font-size:12px;color:#a1a1aa;padding-top:8px;width:100%;">${ex.series.map(s => `${s.reps}x${s.weight}kg`).join(' • ')}</div></div>`).join('')}`;
            document.getElementById('start-workout-btn').style.display = 'block';
            showScreen('detail-screen');
        }

        function startWorkoutFromHome(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) return;
            currentWorkout = JSON.parse(JSON.stringify(workout));
            startLiveWorkout();
        }

        function startLiveWorkout() {
            if (!currentWorkout || currentWorkout.exercises.length === 0) return;
            currentExerciseIndex = 0; currentSetIndex = 0; performanceData = {};
            workoutStartTime = Date.now();
            document.getElementById('live-workout-name').textContent = currentWorkout.name;
            startTimer();
            updateLiveWorkoutDisplay();
            showScreen('live-screen');
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const e = Date.now() - workoutStartTime, h = (~~(e/36e5)).toString().padStart(2,'0'), m = (~~((e%36e5)/6e4)).toString().padStart(2,'0'), s = (~~((e%6e4)/1e3)).toString().padStart(2,'0');
                document.getElementById('workout-timer').textContent = `${h}:${m}:${s}`;
            }, 1000);
        }

        function updateLiveWorkoutDisplay() {
            const ex = currentWorkout.exercises[currentExerciseIndex];
            if (!ex) return;
            document.getElementById('current-exercise-name').textContent = ex.name;
            document.getElementById('exercise-progress').textContent = `Esercizio ${currentExerciseIndex + 1}/${currentWorkout.exercises.length} • Serie ${currentSetIndex + 1}/${ex.series.length}`;
            document.getElementById('sets-container').innerHTML = ex.series.map((serie, sIdx) => {
                const key = `${currentExerciseIndex}-${sIdx}`, perf = performanceData[key], isCompleted = !!perf, w = perf?.weight ?? serie.weight;
                const note = perf?.note ?? '';
                return `<div class="set-item ${isCompleted?'completed':''} ${sIdx===currentSetIndex?'current':''} ${isResting?'disabled':''}">
                    <div class="set-item-main">
                        <div class="set-info"><h4>Serie ${sIdx + 1}</h4><p>${serie.reps} rep ${isCompleted?`(eff: ${perf.reps})`:''}</p></div>
                        <div class="set-input-group"><input type="number" class="set-input" id="live-weight-${key}" value="${w}"> kg</div>
                        <div class="set-actions">
                           <button class="note-btn" onclick="toggleNoteInput('${key}')">💬</button>
                           <button class="complete-btn" onclick="completeSet(${currentExerciseIndex}, ${sIdx})">${isCompleted?'✓':''}</button>
                        </div>
                    </div>
                    <input type="text" class="set-note-input hidden" id="live-note-${key}" placeholder="Nota per la serie..." value="${note}">
                </div>`;
            }).join('');
            const isFirst = currentExerciseIndex === 0 && currentSetIndex === 0;
            const isLast = currentExerciseIndex === currentWorkout.exercises.length - 1 && currentSetIndex === ex.series.length - 1;
            document.getElementById('prev-btn').disabled = isFirst || isResting;
            document.getElementById('next-btn').disabled = isLast || isResting;
        }

        function toggleNoteInput(key) { document.getElementById(`live-note-${key}`).classList.toggle('hidden'); }
        function completeSet(exIdx, setIdx) {
            const key = `${exIdx}-${setIdx}`;
            const isCompleted = !!performanceData[key];
            performanceData[key] = { reps: currentWorkout.exercises[exIdx].series[setIdx].reps, weight: parseFloat(document.getElementById(`live-weight-${key}`).value) || 0, note: document.getElementById(`live-note-${key}`).value.trim() };

            if (isCompleted) {
                updateLiveWorkoutDisplay();
                return;
            }

            const isLastSet = setIdx === currentWorkout.exercises[exIdx].series.length - 1, isLastEx = exIdx === currentWorkout.exercises.length - 1;
            if (isLastSet && isLastEx) nextSet();
            else startRestTimer();
        }
        function startRestTimer() {
            isResting = true; const ex = currentWorkout.exercises[currentExerciseIndex]; const duration = ex.rest || 60;
            const [modal, timer, info] = ['rest-timer-modal','rest-timer-display','next-up-info'].map(id=>document.getElementById(id));
            let nextEx = ex, nextSetNum = currentSetIndex + 2;
            if (nextSetNum > nextEx.series.length && currentExerciseIndex + 1 < currentWorkout.exercises.length) {
                nextEx = currentWorkout.exercises[currentExerciseIndex + 1]; info.textContent = `${nextEx.name} - Serie 1`;
            } else { info.textContent = `${nextEx.name} - Serie ${nextSetNum}`; }
            modal.classList.remove('hidden'); updateLiveWorkoutDisplay();
            let timeLeft = duration; timer.textContent = new Date(timeLeft*1000).toISOString().substr(14,5);
            if (restTimerInterval) clearInterval(restTimerInterval);
            restTimerInterval = setInterval(() => { 
                timeLeft--; 
                timer.textContent = new Date(timeLeft*1000).toISOString().substr(14,5); 
                
                // Beep negli ultimi 3 secondi
                if (timeLeft <= 3 && timeLeft > 0 && restAudio) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }
                
                if (timeLeft <= 0) {
                    clearInterval(restTimerInterval);
                    if (restAudio) restAudio.play();
                    setTimeout(skipRest, 1000);
                }
            }, 1000);
        }
        function skipRest() { 
    if (restTimerInterval) clearInterval(restTimerInterval); 
    isResting=false; 
    document.getElementById('rest-timer-modal').classList.add('hidden'); 
    nextSet(); 
}
        function previousSet() { if(isResting)return; if(currentSetIndex>0)currentSetIndex--; else if(currentExerciseIndex>0){currentExerciseIndex--;currentSetIndex=currentWorkout.exercises[currentExerciseIndex].series.length-1;} updateLiveWorkoutDisplay(); }
        function nextSet(manual=false) { if(isResting&&manual)return; const ex=currentWorkout.exercises[currentExerciseIndex]; if(currentSetIndex<ex.series.length-1)currentSetIndex++; else if(currentExerciseIndex<currentWorkout.exercises.length-1){currentExerciseIndex++;currentSetIndex=0;} updateLiveWorkoutDisplay(); }
        function showEditExerciseModal() { const ex = currentWorkout.exercises[currentExerciseIndex]; document.getElementById('modal-exercise-name').value = ex.name; document.getElementById('modal-exercise-rest').value = ex.rest; document.getElementById('edit-exercise-modal').classList.remove('hidden'); }
        function hideEditExerciseModal() { document.getElementById('edit-exercise-modal').classList.add('hidden'); }
        function saveLiveExerciseChanges() { const ex = currentWorkout.exercises[currentExerciseIndex]; ex.name = document.getElementById('modal-exercise-name').value.trim() || ex.name; ex.rest = parseInt(document.getElementById('modal-exercise-rest').value) || ex.rest; hideEditExerciseModal(); updateLiveWorkoutDisplay(); }
        function isExerciseCompleted(exIdx) { const ex=currentWorkout.exercises[exIdx]; return ex.series.every((s, sIdx) => !!performanceData[`${exIdx}-${sIdx}`]); }
        function showExercisePicker() { document.getElementById('exercise-picker-list').innerHTML = currentWorkout.exercises.map((ex, idx) => `<div class="workout-card ${isExerciseCompleted(idx)?'completed':''}" onclick="selectExercise(${idx})"><div class="workout-icon">${isExerciseCompleted(idx)?'✓':'💪'}</div><div class="workout-info"><h3>${ex.name}</h3></div></div>`).join(''); document.getElementById('exercise-picker-modal').classList.remove('hidden'); }
        function hideExercisePicker() { document.getElementById('exercise-picker-modal').classList.add('hidden'); }
        function selectExercise(index) { currentExerciseIndex=index; currentSetIndex=0; updateLiveWorkoutDisplay(); hideExercisePicker(); }
        function finishWorkout() {
            if (timerInterval) clearInterval(timerInterval);
            const duration = Math.max(1, Math.floor((Date.now() - workoutStartTime) / 60000));
            document.querySelectorAll('.set-note-input').forEach(input => {
                const key = input.id.replace('live-note-', '');
                if (performanceData[key]) {
                    performanceData[key].note = input.value.trim();
                }
            });
            const finished = { ...currentWorkout, id: Date.now().toString(), date: new Date().toISOString(), duration, isTemplate: false, performance: performanceData };
            workouts.unshift(finished);
            localStorage.setItem(DB_KEY, JSON.stringify(workouts));
            updateAllScreens(); showWorkoutDetail(finished.id);
        }
        function endLiveWorkout() { if(confirm('Sei sicuro? I progressi non saranno salvati.')){if(timerInterval)clearInterval(timerInterval);if(restTimerInterval)clearInterval(restTimerInterval);goBack();} }
        
        // --- AI SCAN FUNCTIONS ---
        function triggerFileInput() { document.getElementById('file-input').click(); }
        async function handleImageUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            const uploadArea = document.getElementById('upload-area'), uploadContent = document.getElementById('upload-content'), errorDiv = document.getElementById('scan-error');
            uploadArea.classList.add('loading'); uploadContent.innerHTML = '<div class="spinner"></div><p>Analizzando...</p>'; errorDiv.classList.add('hidden');
            try {
                const base64 = await fileToBase64(file);
                const workoutData = await analyzeWorkoutImage(base64);
                setWorkoutTab('manual');
                document.getElementById('workout-name').value = workoutData.workoutName || "Workout Scansionato";
                renderExerciseBuilder(workoutData.exercises || []);
                uploadContent.innerHTML = '<p style="color: #16a34a;">✓ Analisi completata!</p>';
            } catch (error) {
                console.error('Errore analisi immagine:', error);
                errorDiv.textContent = error.message || 'Analisi fallita. Riprova.';
                errorDiv.classList.remove('hidden');
                uploadContent.innerHTML = '<p>Clicca per caricare</p>';
            } finally { uploadArea.classList.remove('loading'); }
        }
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); }
        async function analyzeWorkoutImage(base64Image) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_API_KEY') { throw new Error("API Key di Gemini non configurata."); }
            const prompt = `Analizza l'immagine di questo workout. Estrai il nome del workout e una lista di esercizi.
Per ogni esercizio, estrai:
1.  'name': Il nome dell'esercizio.
2.  'sets': Il numero totale di serie allenanti.
3.  'reps': Le ripetizioni. Interpreta queste abbreviazioni: 'wu' = 15, 'w' = 6, 'b' = 12. Se vedi 'f' (es. '2f'), significa cedimento, interpretalo come un range tipo '10-8'.
4.  'weight': Il peso usato.
5.  'note': Qualsiasi nota aggiuntiva sull'esercizio.
6.  'rest': Il tempo di recupero in secondi (es. 60s, 90s, 2').

Restituisci un JSON con questa struttura:
{"workoutName": "string", "exercises": [{"name": "string", "sets": number, "reps": "string|number", "weight": number, "note": "string", "rest": number}]}.
Se un valore non c'è, stimalo o usa un valore di default sensato (es. rest: 60).`;

            const requestBody = {
                contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64Image }} ]}],
                generationConfig: { temperature: 0.1, maxOutputTokens: 4096, responseMimeType: "application/json" }
            };
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) { const err = await response.json(); throw new Error(`API error: ${err.error?.message || response.status}`); }
            const data = await response.json();
            const aiWorkout = JSON.parse(data.candidates[0].content.parts[0].text);
            
            // Convert AI data to the app's structure
            const formattedExercises = aiWorkout.exercises.map(ex => {
                const series = [];
                let reps = ex.reps;
                if(typeof reps === 'string' && reps.includes('-')) {
                    reps = parseInt(reps.split('-')[0]); // Take the higher number of the range for simplicity
                }
                for (let i = 0; i < (ex.sets || 0); i++) {
                    series.push({ reps: reps || 0, weight: ex.weight || 0, note: '' });
                }
                return { name: ex.name, note: ex.note || '', rest: ex.rest || 60, series };
            });
            return { workoutName: aiWorkout.workoutName, exercises: formattedExercises };
        }
        
        document.addEventListener('click', e => { if (e.target.matches('.modal')) { e.target.classList.add('hidden'); if(e.target.id==='rest-timer-modal')skipRest();} });
    </script>
</body>
</html>
