<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GymPal AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body, #root {
      min-height: 100vh;
    }
    body { 
      font-family: 'Inter', sans-serif; 
      -webkit-tap-highlight-color: transparent;
    }
    /* Simple scrollbar styling for better aesthetics */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Styles for AI-generated exercise info */
    .exercise-info h3 {
        font-size: 1.125rem; /* text-lg */
        font-weight: 600; /* semibold */
        margin-top: 1.25rem; /* mt-5 */
        margin-bottom: 0.75rem; /* mb-3 */
        color: #1f2937; /* text-gray-800 */
    }
    .dark .exercise-info h3 {
        color: #f9fafb; /* text-gray-50 */
    }
    .exercise-info h3:first-child {
        margin-top: 0;
    }
    .exercise-info p {
        line-height: 1.6;
    }
    .exercise-info ul {
        list-style-type: disc;
        padding-left: 1.5rem; /* pl-6 */
        margin-top: 0.5rem;
    }
    .exercise-info li {
        margin-bottom: 0.5rem; /* mb-2 */
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "@google/genai": "https://esm.sh/@google/genai@^1.8.0"
  }
}
</script>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
  <div id="root"></div>

  <script type="module">
    import React, { useState, useEffect, useCallback, useRef } from 'https://esm.sh/react@19.1.0';
    import ReactDOM from 'https://esm.sh/react-dom@19.1.0/client';
    import { GoogleGenAI } from 'https://esm.sh/@google/genai@1.8.0';

    // ===== CONSTANTS & ICONS =====
    const LogoIcon = ({ className }) => (
        React.createElement('svg', {
            className: className || "h-24 w-24",
            viewBox: "0 0 24 24",
            fill: "none",
            xmlns: "http://www.w3.org/2000/svg"
        },
            React.createElement('path', {
                d: "M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z",
                stroke: "currentColor",
                strokeWidth: "1.5",
                strokeLinecap: "round",
                strokeLinejoin: "round"
            }),
            React.createElement('path', {
                d: "M7 12H17",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round"
            }),
            React.createElement('path', {
                d: "M7 12H5C4.44772 12 4 11.5523 4 11V13C4 13.5523 4.44772 14 5 14H7",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round"
            }),
            React.createElement('path', {
                d: "M17 12H19C19.5523 12 20 11.5523 20 11V13C20 13.5523 19.5523 14 19 14H17",
                stroke: "currentColor",
                strokeWidth: "2",
                strokeLinecap: "round",
                strokeLinejoin: "round"
            })
        )
    );

    const PlusIcon = () => (
      React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-6 w-6', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 4v16m8-8H4' })
      )
    );

    const CameraIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 1.5 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z' }),
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M15 13a3 3 0 11-6 0 3 3 0 016 0z' })
        )
    );

    const ChevronLeftIcon = () => (
      React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-6 w-6', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M15 19l-7-7 7-7' })
      )
    );

    const ChevronRightIcon = () => (
      React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-6 w-6', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M9 5l7 7-7 7' })
      )
    );

    const ChevronDownIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M19 9l-7 7-7-7' })
        )
    );

    const CheckIcon = ({ className }) => (
      React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-5 w-5", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 3 },
          React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M5 13l4 4L19 7' })
      )
    );

    const TrashIcon = ({ className }) => (
      React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || 'h-5 w-5', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16' })
      )
    );

    const ClockIcon = () => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-6 w-6 text-gray-500 dark:text-gray-400', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
          React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' })
        )
    );

    const EditIcon = () => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-5 w-5', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
          React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z' })
        )
    );
    
    const PlusCircleIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z' })
        )
    );

    const MinusCircleIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z' })
        )
    );

    const SwitchHorizontalIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 1.5 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4' })
        )
    );

    const SparklesIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 1.5 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.523L16.5 21.75l-.398-1.227a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.227-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.227a2.25 2.25 0 001.423 1.423L19.5 18.75l-1.227.398a2.25 2.25 0 00-1.423 1.423z' })
        )
    );

    const BookOpenIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 1.5 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0 0v14.25' })
        )
    );
    
    const DocumentAddIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 1.5 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' })
        )
    );

    const XIcon = ({ className }) => (
        React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: className || "h-6 w-6", fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor', strokeWidth: 2 },
            React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', d: 'M6 18L18 6M6 6l12 12' })
        )
    );

    // ===== DATA & PROMPTS =====
    const EXERCISE_LIBRARY = {
        'panca piana': {
            name: 'Panca Piana con Bilanciere',
            description: 'Esercizio fondamentale per lo sviluppo della parte superiore del corpo, in particolare del petto, delle spalle anteriori e dei tricipiti.',
            muscles_primary: ['Pettorali (Grande Pettorale)'],
            muscles_secondary: ['Deltoidi Anteriori', 'Tricipiti'],
            gif_url: 'https://gymvisual.com/img/p/1/7/4/7/1/17471.gif'
        },
        'squat': {
            name: 'Squat con Bilanciere',
            description: 'Re degli esercizi per le gambe, lo squat lavora quasi tutti i muscoli della parte inferiore del corpo e rafforza il core.',
            muscles_primary: ['Quadricipiti', 'Glutei'],
            muscles_secondary: ['Adduttori', 'Muscoli Posteriori della Coscia', 'Core'],
            gif_url: 'https://gymvisual.com/img/p/1/7/2/4/9/17249.gif'
        },
        'trazioni alla sbarra': {
            name: 'Trazioni alla Sbarra',
            description: 'Esercizio a corpo libero eccellente per la schiena e i bicipiti. La presa può variare per enfasi muscolare diversa.',
            muscles_primary: ['Gran Dorsale', 'Bicipiti'],
            muscles_secondary: ['Romboidi', 'Deltoidi Posteriori', 'Trapezi'],
            gif_url: 'https://gymvisual.com/img/p/1/5/4/3/8/15438.gif'
        },
        'rematore con bilanciere': {
            name: 'Rematore con Bilanciere',
            description: 'Esercizio chiave per costruire spessore e forza nella schiena. Mantenere la schiena dritta è fondamentale per la sicurezza.',
            muscles_primary: ['Gran Dorsale', 'Romboidi', 'Trapezi'],
            muscles_secondary: ['Bicipiti', 'Deltoidi Posteriori'],
            gif_url: 'https://gymvisual.com/img/p/1/7/4/7/5/17475.gif'
        },
        'lento avanti': {
            name: 'Lento Avanti con Bilanciere',
            description: 'Esercizio fondamentale per la costruzione di spalle forti e larghe. Può essere eseguito in piedi o da seduto.',
            muscles_primary: ['Deltoidi (Anteriori e Mediali)'],
            muscles_secondary: ['Tricipiti', 'Trapezi'],
            gif_url: 'https://gymvisual.com/img/p/1/7/5/2/3/17523.gif'
        }
    };

    const GEMINI_OCR_PROMPT = `
Sei un esperto fitness coach e specialista nell'inserimento dati. Il tuo compito è analizzare l'immagine di un piano di allenamento scritto a mano o stampato e convertirlo in un formato JSON strutturato.

L'utente fornirà un'immagine della sua scheda di allenamento. Devi eseguire il Riconoscimento Ottico dei Caratteri (OCR) sull'immagine per estrarre tutti gli esercizi, le serie, le ripetizioni, i tempi di riposo e qualsiasi nota specifica per ogni esercizio.

Emetti un singolo oggetto JSON che sia conforme alla seguente interfaccia TypeScript:

\`\`\`typescript
interface WorkoutPlan {
  name: string; // es., "Giorno di Spinta", "Allenamento Gambe", "Full Body A"
  exercises: {
    name: string; // es., "Panca Piana", "Squat", "Curl Bicipiti"
    targetSets: number; // Il numero di serie, es., 3
    targetReps: string; // L'intervallo o il numero di ripetizioni, es., "8-12" o "10"
    restTime: number; // Tempo di riposo in secondi tra le serie, es., 60
    description?: string; // Eventuali note specifiche sull'esercizio, es., "Concentrarsi sulla forma", "Andare a cedimento nell'ultima serie"
    supersetKey?: string; // Identificatore per superset/circuiti. Esercizi con la stessa chiave vengono eseguiti consecutivamente. es., "A" per "A1. Panca" e "A2. Trazioni"
  }[];
}
\`\`\`

REGOLE IMPORTANTI:
1.  Analizza l'intera immagine per trovare un titolo per il piano di allenamento. Se non è presente un titolo chiaro, crea un nome descrittivo come "Piano di Allenamento [Data]".
2.  Identifica ogni esercizio e i suoi dettagli.
3.  **SUPERSET/CIRCUITI:** Se noti che degli esercizi sono raggruppati (es. "A1", "A2"; "1a", "1b"; o collegati da una parentesi graffa), assegna loro la stessa \`supersetKey\`. La chiave dovrebbe essere una lettera maiuscola (es., 'A', 'B', 'C'). Esercizi non in superset non devono avere questa chiave. Il tempo di riposo per gli esercizi in superset va applicato DOPO l'ultimo esercizio del gruppo. Assicurati che gli esercizi di un superset siano consecutivi nell'array.
4.  Estrai accuratamente il numero di serie.
5.  Estrai accuratamente le ripetizioni target. Può essere un singolo numero o un intervallo.
6.  **INTERPRETAZIONE REP SPECIALI:** Se nella colonna delle ripetizioni trovi dei codici specifici, traducili come segue: 'WU' corrisponde a '15', '2F' corrisponde a '10, 8', '1B' corrisponde a '12', '2W' corrisponde a '6'. Usa queste stringhe come valore per \`targetReps\`.
7.  Se il tempo di riposo è menzionato, estrailo in secondi. Se non è menzionato per un esercizio, usa un valore predefinito ragionevole di 60 secondi. Se per un superset è indicato un unico tempo di riposo, applicalo a tutti gli esercizi del gruppo.
8.  Se ci sono note o descrizioni per un esercizio specifico, inseriscile nel campo 'description'. In caso contrario, ometti il campo.
9.  L'output finale DEVE essere SOLO l'oggetto JSON, racchiuso tra i marcatori \`\`\`json ... \`\`\`. Non includere nessun altro testo, spiegazione o scusa.
10. Se l'immagine non è chiara o non contiene un piano di allenamento, restituisci un oggetto JSON con un array \`exercises\` vuoto e un nome come "Piano Illeggibile".
`;

    const GEMINI_GENERATOR_PROMPT = `
Sei un personal trainer di fama mondiale e un esperto nella creazione di programmi di allenamento. Il tuo compito è creare un SINGOLO piano di allenamento personalizzato in formato JSON basato sulle specifiche dell'utente.

L'utente fornirà i seguenti dettagli:
- Nome del Piano: Il tipo di allenamento desiderato (es. "Giorno di Spinta", "Allenamento Gambe e Glutei", "Full Body per Principianti").
- Obiettivo: L'obiettivo primario dell'allenamento (es. "Ipertrofia", "Forza", "Perdita di Grasso").
- Livello di esperienza: Il livello di fitness dell'utente (es. "Principiante", "Intermedio", "Avanzato").
- Note aggiuntive: Qualsiasi richiesta specifica, attrezzatura disponibile o limitazioni.

Basandoti su questi dati, crea il piano di allenamento richiesto.

L'output DEVE essere un SINGOLO oggetto JSON che sia conforme alla seguente interfaccia TypeScript:

\`\`\`typescript
interface WorkoutPlan {
  name: string;
  exercises: {
    name: string;
    targetSets: number;
    targetReps: string;
    restTime: number;
    description?: string;
    supersetKey?: string;
  }[];
}
\`\`\`

REGOLE FONDAMENTALI:
1.  Usa il nome fornito dall'utente per il campo \`name\` del piano JSON.
2.  Scegli da 5 a 8 esercizi appropriati per il tipo di allenamento, l'obiettivo e il livello richiesti. Varia gli esercizi per un allenamento bilanciato.
3.  Imposta serie (\`targetSets\`), ripetizioni (\`targetReps\`) e tempi di riposo (\`restTime\` in secondi) in base all'obiettivo e al livello dell'utente. Segui queste linee guida generali:
    - **Forza**: 3-5 serie, 4-6 ripetizioni, 120-180s di riposo.
    - **Ipertrofia (Guadagno Muscolare)**: 3-4 serie, 8-12 ripetizioni, 60-90s di riposo.
    - **Resistenza/Perdita Grasso**: 2-4 serie, 12-20 ripetizioni, 30-60s di riposo.
4.  Per i principianti, prediligi esercizi fondamentali e meno complessi. Per gli avanzati, puoi includere tecniche più complesse.
5.  Aggiungi note utili e concise nel campo \`description\` per gli esercizi che lo richiedono (es. "Controlla la fase negativa", "Mantieni il core contratto").
6.  Puoi usare i superset (\`supersetKey\`) se è una strategia efficace per l'obiettivo (es. per aumentare l'intensità nella perdita di grasso).
7.  L'output finale DEVE essere SOLO l'oggetto JSON, racchiuso tra i marcatori \`\`\`json ... \`\`\`. Non includere nessun altro testo, spiegazione o saluto.
`;

    // ===== GEMINI SERVICE =====
    const API_KEY = "AIzaSyCmT_pq7Hvv14YaLRxhr0_LkHDQAg67-ik";
    const ai = new GoogleGenAI({ apiKey: API_KEY });

    function fileToGenerativePart(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                if (event.target?.result) {
                    const base64 = event.target.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64,
                            mimeType: file.type,
                        },
                    });
                } else {
                    reject(new Error("Impossibile leggere il file."));
                }
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }
    
    const processApiResponse = (response) => {
        let jsonStr = response.text.trim();
        const fenceRegex = /^```(\w*)?\s*\n?(.*?)\n?\s*```$/s;
        const match = jsonStr.match(fenceRegex);
        if (match && match[2]) {
            jsonStr = match[2].trim();
        }
        const parsedData = JSON.parse(jsonStr);
        return {
            ...parsedData,
            id: `plan_${Date.now()}`
        };
    };

    const parseWorkoutSheet = async (imageFile) => {
        const imagePart = await fileToGenerativePart(imageFile);
        const textPart = { text: GEMINI_OCR_PROMPT };

        try {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash-preview-04-17',
                contents: { parts: [imagePart, textPart] },
                config: { responseMimeType: "application/json" }
            });
            return processApiResponse(response);
        } catch (error) {
            console.error("Errore durante l'analisi della scheda (OCR):", error);
            throw new Error("Impossibile interpretare la scheda. Prova con un'immagine più chiara.");
        }
    };

    const generateWorkoutPlan = async (formData) => {
        const userPrompt = `
            Genera un piano di allenamento basato sui seguenti dettagli:
            - Nome del Piano: ${formData.name}
            - Obiettivo: ${formData.goal}
            - Livello di esperienza: ${formData.level}
            - Note aggiuntive: ${formData.notes || 'Nessuna'}
        `;
        const fullPrompt = `${GEMINI_GENERATOR_PROMPT}\n\n${userPrompt}`;
        const textPart = { text: fullPrompt };

        try {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash-preview-04-17',
                contents: { parts: [textPart] },
                config: { responseMimeType: "application/json" }
            });
            return processApiResponse(response);
        } catch (error) {
            console.error("Errore durante la generazione del piano:", error);
            throw new Error("Impossibile generare il piano. Riprova modificando i parametri.");
        }
    };

    // ===== COMMON COMPONENTS =====
    const Spinner = ({ className = 'h-8 w-8 text-blue-600 dark:text-blue-400' }) => (
        React.createElement('div', { role: 'status' },
            React.createElement('svg', {
                'aria-hidden': 'true',
                className: `animate-spin ${className}`,
                viewBox: '0 0 100 101',
                fill: 'none',
                xmlns: 'http://www.w3.org/2000/svg'
            },
                React.createElement('path', {
                    d: 'M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 28.0035 72.5987 9.68361 50 9.68361C27.4013 9.68361 9.08144 28.0035 9.08144 50.5908Z',
                    fill: 'currentColor',
                    fillOpacity: '0.2'
                }),
                React.createElement('path', {
                    d: 'M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z',
                    fill: 'currentColor'
                })
            ),
            React.createElement('span', { className: 'sr-only' }, 'Caricamento...')
        )
    );

    // ===== HOOKS =====
    const useWorkoutStore = () => {
        const WORKOUT_PLANS_KEY = 'gym-pal-ai-workout-plans';
        const WORKOUT_SESSIONS_KEY = 'gym-pal-ai-workout-sessions';

        const [plans, setPlans] = useState([]);
        const [sessions, setSessions] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            try {
                const storedPlans = localStorage.getItem(WORKOUT_PLANS_KEY);
                if (storedPlans) setPlans(JSON.parse(storedPlans));
                
                const storedSessions = localStorage.getItem(WORKOUT_SESSIONS_KEY);
                if (storedSessions) setSessions(JSON.parse(storedSessions));
            } catch (error) {
                console.error("Failed to load data from localStorage", error);
                localStorage.removeItem(WORKOUT_PLANS_KEY);
                localStorage.removeItem(WORKOUT_SESSIONS_KEY);
            } finally {
                setLoading(false);
            }
        }, []);

        useEffect(() => {
            if (!loading) {
                localStorage.setItem(WORKOUT_PLANS_KEY, JSON.stringify(plans));
            }
        }, [plans, loading]);

        useEffect(() => {
            if (!loading) {
                localStorage.setItem(WORKOUT_SESSIONS_KEY, JSON.stringify(sessions));
            }
        }, [sessions, loading]);
        
        const addPlan = useCallback((plan) => {
            setPlans(prevPlans => [...prevPlans, plan]);
        }, []);

        const updatePlan = useCallback((updatedPlan) => {
            setPlans(prevPlans => prevPlans.map(p => (p.id === updatedPlan.id ? updatedPlan : p)));
        }, []);

        const deletePlan = useCallback((planId) => {
            setPlans(prevPlans => prevPlans.filter(p => p.id !== planId));
            setSessions(prevSessions => prevSessions.filter(s => s.planId !== planId));
        }, []);

        const startWorkoutSession = useCallback((plan) => {
            const newSession = {
                id: `session_${Date.now()}`,
                planId: plan.id,
                planName: plan.name,
                startTime: Date.now(),
                endTime: null,
                exercises: plan.exercises.map((ex, index) => ({
                    name: ex.name,
                    description: ex.description,
                    targetSets: ex.targetSets,
                    targetReps: ex.targetReps,
                    restTime: ex.restTime,
                    supersetKey: ex.supersetKey,
                    id: `ex_${Date.now()}_${index}`,
                    sets: Array.from({ length: ex.targetSets }, (_, i) => ({
                        id: `set_${Date.now()}_${index}_${i}`,
                        reps: null,
                        weight: null,
                        completed: false,
                    })),
                })),
            };
            setSessions(prev => [...prev, newSession]);
            return newSession;
        }, []);

        const updateWorkoutSession = useCallback((updatedSession) => {
            setSessions(prevSessions =>
                prevSessions.map(s => (s.id === updatedSession.id ? updatedSession : s))
            );
        }, []);

        const getSessionById = useCallback((sessionId) => {
            return sessions.find(s => s.id === sessionId);
        }, [sessions]);


        return {
            plans, sessions, loading, addPlan, updatePlan, deletePlan,
            startWorkoutSession, updateWorkoutSession, getSessionById,
        };
    };

    // ===== COMPONENTS =====
    
    const WorkoutGenerator = ({ onPlanGenerated }) => {
        const [formData, setFormData] = useState({
            name: 'Giorno di Spinta',
            goal: 'hypertrophy',
            level: 'intermediate',
            notes: ''
        });
        const [isGenerating, setIsGenerating] = useState(false);
        const [error, setError] = useState(null);

        const handleInputChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!formData.name) {
                setError("Il nome del piano è obbligatorio.");
                return;
            }
            setIsGenerating(true);
            setError(null);
            try {
                const newPlan = await generateWorkoutPlan(formData);
                if (newPlan.exercises && newPlan.exercises.length > 0) {
                    onPlanGenerated(newPlan);
                    setFormData({ name: '', goal: 'hypertrophy', level: 'intermediate', notes: '' });
                } else {
                    setError("L'IA non è riuscita a generare un piano. Prova a modificare i tuoi requisiti.");
                }
            } catch (err) {
                setError(err.message);
            } finally {
                setIsGenerating(false);
            }
        };

        return React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md space-y-4' },
            React.createElement('h3', { className: 'font-semibold text-lg text-gray-800 dark:text-white' }, 'Genera con Testo'),
            error && React.createElement('div', { className: "p-3 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800", role: "alert" }, error),
            React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' },
                React.createElement('div', null,
                    React.createElement('label', { htmlFor: 'plan-name', className: 'block text-sm font-medium text-gray-700 dark:text-gray-300' }, 'Nome / Tipo di Piano'),
                    React.createElement('input', { type: 'text', name: 'name', id: 'plan-name', value: formData.name, onChange: handleInputChange, required: true, placeholder: 'Es. Allenamento Gambe', className: 'mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm' })
                ),
                React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-2 gap-4' },
                    React.createElement('div', null,
                        React.createElement('label', { htmlFor: 'goal', className: 'block text-sm font-medium text-gray-700 dark:text-gray-300' }, 'Obiettivo'),
                        React.createElement('select', { name: 'goal', id: 'goal', value: formData.goal, onChange: handleInputChange, className: 'mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm' },
                            React.createElement('option', { value: 'hypertrophy' }, 'Ipertrofia'),
                            React.createElement('option', { value: 'strength' }, 'Forza'),
                            React.createElement('option', { value: 'fat_loss' }, 'Perdita Grasso')
                        )
                    ),
                    React.createElement('div', null,
                        React.createElement('label', { htmlFor: 'level', className: 'block text-sm font-medium text-gray-700 dark:text-gray-300' }, 'Livello'),
                        React.createElement('select', { name: 'level', id: 'level', value: formData.level, onChange: handleInputChange, className: 'mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm' },
                            React.createElement('option', { value: 'beginner' }, 'Principiante'),
                            React.createElement('option', { value: 'intermediate' }, 'Intermedio'),
                            React.createElement('option', { value: 'advanced' }, 'Avanzato')
                        )
                    )
                ),
                React.createElement('div', null,
                    React.createElement('label', { htmlFor: 'notes', className: 'block text-sm font-medium text-gray-700 dark:text-gray-300' }, 'Note Aggiuntive'),
                    React.createElement('textarea', { name: 'notes', id: 'notes', rows: '2', value: formData.notes, onChange: handleInputChange, placeholder: 'Es. Ho solo manubri e una panca', className: 'mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm' })
                ),
                React.createElement('button', { type: 'submit', disabled: isGenerating, className: 'w-full flex justify-center items-center gap-2 px-4 py-2 text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-blue-400 disabled:cursor-not-allowed transition-colors' },
                    isGenerating ? React.createElement(Spinner, { className: 'h-5 w-5 text-white' }) : React.createElement(SparklesIcon, { className: 'h-5 w-5' }),
                    isGenerating ? 'Generazione...' : 'Genera Piano'
                )
            )
        );
    };

    const ManualPlanBuilder = ({ onPlanAdded }) => {
        const [planName, setPlanName] = useState('');
        const [exercises, setExercises] = useState([
            { id: Date.now(), name: '', targetSets: 3, targetReps: '8-12', restTime: 60, description: '' }
        ]);

        const handleExerciseChange = (index, field, value) => {
            const newExercises = [...exercises];
            newExercises[index][field] = value;
            setExercises(newExercises);
        };

        const addExercise = () => {
            setExercises([
                ...exercises,
                { id: Date.now(), name: '', targetSets: 3, targetReps: '8-12', restTime: 60, description: '' }
            ]);
        };

        const removeExercise = (index) => {
            const newExercises = exercises.filter((_, i) => i !== index);
            setExercises(newExercises);
        };

        const handleSave = () => {
            if (!planName.trim() || exercises.some(ex => !ex.name.trim())) {
                alert("Per favore, inserisci un nome per il piano e per ogni esercizio.");
                return;
            }
            const newPlan = {
                id: `plan_${Date.now()}`,
                name: planName,
                exercises: exercises.map(ex => ({
                    name: ex.name,
                    targetSets: Number(ex.targetSets),
                    targetReps: ex.targetReps,
                    restTime: Number(ex.restTime),
                    description: ex.description
                }))
            };
            onPlanAdded(newPlan);
        };

        return React.createElement('div', { className: 'space-y-6' },
            React.createElement('h1', { className: 'text-3xl font-bold text-gray-800 dark:text-white' }, 'Crea Piano Manuale'),
            React.createElement('div', { className: 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md space-y-4' },
                React.createElement('div', null,
                    React.createElement('label', { htmlFor: 'manual-plan-name', className: 'block text-sm font-medium text-gray-700 dark:text-gray-300' }, 'Nome del Piano'),
                    React.createElement('input', { type: 'text', id: 'manual-plan-name', value: planName, onChange: e => setPlanName(e.target.value), placeholder: 'Es. Full Body A', className: 'mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm' })
                ),
                React.createElement('div', { className: 'space-y-4' },
                    exercises.map((ex, index) => React.createElement('div', { key: ex.id, className: 'p-3 border border-gray-200 dark:border-gray-700 rounded-lg space-y-3' },
                        React.createElement('div', { className: 'flex justify-between items-center' },
                            React.createElement('p', { className: 'font-semibold text-gray-800 dark:text-white' }, `Esercizio ${index + 1}`),
                            exercises.length > 1 && React.createElement('button', { onClick: () => removeExercise(index), className: 'p-1 text-red-500 hover:bg-red-100 dark:hover:bg-gray-700 rounded-full' }, React.createElement(TrashIcon, { className: 'h-4 w-4' }))
                        ),
                        React.createElement('input', { type: 'text', value: ex.name, onChange: e => handleExerciseChange(index, 'name', e.target.value), placeholder: 'Nome Esercizio', className: 'block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm sm:text-sm' }),
                        React.createElement('div', { className: 'grid grid-cols-3 gap-2' },
                            React.createElement('input', { type: 'number', value: ex.targetSets, onChange: e => handleExerciseChange(index, 'targetSets', e.target.value), placeholder: 'Serie', className: 'block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm sm:text-sm' }),
                            React.createElement('input', { type: 'text', value: ex.targetReps, onChange: e => handleExerciseChange(index, 'targetReps', e.target.value), placeholder: 'Rep', className: 'block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm sm:text-sm' }),
                            React.createElement('input', { type: 'number', value: ex.restTime, onChange: e => handleExerciseChange(index, 'restTime', e.target.value), placeholder: 'Recupero (s)', className: 'block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm sm:text-sm' })
                        ),
                        React.createElement('textarea', { value: ex.description, onChange: e => handleExerciseChange(index, 'description', e.target.value), placeholder: 'Note (opzionale)', rows: 1, className: 'block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 shadow-sm sm:text-sm' })
                    )),
                    React.createElement('button', { onClick: addExercise, className: 'w-full flex justify-center items-center gap-2 px-4 py-2 text-sm text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-gray-700 rounded-lg hover:bg-blue-100 dark:hover:bg-gray-600' },
                        React.createElement(PlusCircleIcon, { className: 'h-5 w-5' }), 'Aggiungi Esercizio'
                    )
                ),
                React.createElement('button', { onClick: handleSave, className: 'w-full flex justify-center items-center gap-2 px-4 py-2 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700' }, 'Salva Piano')
            )
        );
    };

    const Dashboard = ({ plans, onAddPlan, onUpdatePlan, onDeletePlan, onStartWorkout }) => {
        const [isUploading, setIsUploading] = useState(false);
        const [error, setError] = useState(null);
        const [editingPlanId, setEditingPlanId] = useState(null);
        const [editingPlanName, setEditingPlanName] = useState('');
        const [expandedPlanId, setExpandedPlanId] = useState(null);
        const fileInputRef = useRef(null);
        const editInputRef = useRef(null);

        useEffect(() => {
            if (editingPlanId && editInputRef.current) {
                editInputRef.current.focus();
            }
        }, [editingPlanId]);

        const handleFileChange = async (event) => {
            const file = event.target.files?.[0];
            if (file) {
                setIsUploading(true);
                setError(null);

                if (!navigator.onLine) {
                    setError("È necessaria una connessione a Internet per analizzare una nuova scheda.");
                    setIsUploading(false);
                    if (fileInputRef.current) fileInputRef.current.value = "";
                    return;
                }

                try {
                    const newPlan = await parseWorkoutSheet(file);
                    if (newPlan.exercises.length > 0) {
                        onAddPlan(newPlan);
                    } else {
                        setError("Impossibile trovare esercizi nell'immagine. Riprova con una foto più chiara.");
                    }
                } catch (e) {
                    setError(e.message || "Si è verificato un errore sconosciuto.");
                } finally {
                    setIsUploading(false);
                }
            }
            if (fileInputRef.current) {
                fileInputRef.current.value = "";
            }
        };
        
        const triggerFileUpload = () => {
            fileInputRef.current?.click();
        };

        const handleEditClick = (plan) => {
            setEditingPlanId(plan.id);
            setEditingPlanName(plan.name);
            setExpandedPlanId(null);
        };

        const handleSaveClick = (planId) => {
            if (editingPlanName.trim() === '') return;
            const planToUpdate = plans.find(p => p.id === planId);
            if (planToUpdate) {
                onUpdatePlan({ ...planToUpdate, name: editingPlanName.trim() });
            }
            setEditingPlanId(null);
            setEditingPlanName('');
        };

        const handleCancelEdit = () => {
            setEditingPlanId(null);
            setEditingPlanName('');
        };
        
        const handleToggleExpand = (planId) => {
            if (editingPlanId === planId) return;
            setExpandedPlanId(prevId => (prevId === planId ? null : planId));
        };

        return React.createElement('div', { className: "space-y-8 pt-8" },
            React.createElement('div', { className: 'text-center' },
                React.createElement(LogoIcon, { className: 'h-24 w-24 mx-auto text-blue-600 dark:text-blue-400' }),
                React.createElement('h1', { className: 'mt-4 text-4xl font-bold tracking-tight text-gray-800 dark:text-white' }, 'GymPal AI'),
                React.createElement('p', { className: 'mt-2 text-lg text-gray-500 dark:text-gray-400' }, 'Il tuo compagno di allenamento intelligente.')
            ),
            React.createElement('input', { type: "file", accept: "image/*", ref: fileInputRef, onChange: handleFileChange, className: "hidden" }),
            error && React.createElement('div', { className: "p-4 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800", role: "alert" }, error),
            
            React.createElement('div', { className: 'space-y-4' },
                React.createElement('h2', { className: 'text-2xl font-semibold text-gray-700 dark:text-gray-300' }, 'Crea con l\'IA'),
                React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
                    React.createElement(WorkoutGenerator, { onPlanGenerated: onAddPlan }),
                    React.createElement('div', { 
                        className: 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex flex-col justify-center items-center text-center cursor-pointer h-full hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors',
                        onClick: triggerFileUpload 
                    },
                        isUploading ? React.createElement(Spinner, { className: 'h-10 w-10 text-blue-500' }) : React.createElement(CameraIcon, { className: 'h-10 w-10 text-gray-400' }),
                        React.createElement('h3', { className: 'mt-4 font-semibold text-lg text-gray-800 dark:text-white' }, isUploading ? 'Analisi in corso...' : 'Carica da Immagine'),
                        React.createElement('p', { className: 'mt-1 text-sm text-gray-500 dark:text-gray-400' }, isUploading ? 'L\'IA sta digitalizzando la tua scheda...' : "Hai già una scheda? Scatta una foto e caricala.")
                    )
                )
            ),

            React.createElement('div', { className: "space-y-4" },
                React.createElement('h2', { className: "text-2xl font-semibold text-gray-700 dark:text-gray-300" }, 'I Miei Piani'),
                plans.length > 0 ? (
                    React.createElement('ul', { className: 'space-y-3' },
                        plans.map(plan => {
                            const isExpanded = expandedPlanId === plan.id;
                            return React.createElement('li', { key: plan.id, className: 'bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden transition-shadow hover:shadow-lg' },
                                React.createElement('div', { className: 'p-4 flex justify-between items-start' },
                                    React.createElement('div', { className: 'flex-grow flex items-start gap-3 cursor-pointer select-none', onClick: () => handleToggleExpand(plan.id) },
                                        React.createElement(ChevronDownIcon, { className: `h-5 w-5 mt-1 text-gray-500 dark:text-gray-400 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}` }),
                                        editingPlanId === plan.id ? (
                                            React.createElement('div', { className: 'flex-grow flex items-center gap-2' },
                                                React.createElement('input', {
                                                    ref: editInputRef,
                                                    type: 'text',
                                                    value: editingPlanName,
                                                    onChange: (e) => setEditingPlanName(e.target.value),
                                                    onBlur: handleCancelEdit,
                                                    onKeyDown: (e) => {
                                                        if (e.key === 'Enter') handleSaveClick(plan.id);
                                                        if (e.key === 'Escape') handleCancelEdit();
                                                    },
                                                    onClick: e => e.stopPropagation(),
                                                    className: 'w-full text-lg bg-gray-100 dark:bg-gray-700 rounded p-1 focus:outline-none focus:ring-2 focus:ring-blue-500'
                                                })
                                            )
                                        ) : (
                                            React.createElement('div', { className: 'flex-grow' },
                                                React.createElement('p', { className: 'font-bold text-lg text-gray-800 dark:text-white' }, plan.name),
                                                React.createElement('p', { className: 'text-sm text-gray-500 dark:text-gray-400' }, `${plan.exercises.length} esercizi`)
                                            )
                                        )
                                    ),
                                    React.createElement('div', { className: 'flex items-center gap-2 flex-shrink-0 ml-4' },
                                        editingPlanId === plan.id ? (
                                            React.createElement('button', { onClick: () => handleSaveClick(plan.id), className: 'p-2 text-green-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors', 'aria-label': `Salva nuovo nome per ${plan.name}` },
                                                React.createElement(CheckIcon, { className: 'h-5 w-5' })
                                            )
                                        ) : (
                                            React.createElement('button', { onClick: (e) => { e.stopPropagation(); handleEditClick(plan); }, className: 'p-2 text-gray-500 hover:text-blue-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors', 'aria-label': `Modifica nome del piano ${plan.name}` },
                                                React.createElement(EditIcon)
                                            )
                                        ),
                                        React.createElement('button', { onClick: (e) => { e.stopPropagation(); onDeletePlan(plan.id); }, className: 'p-2 text-gray-500 hover:text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors', 'aria-label': `Elimina piano ${plan.name}` },
                                            React.createElement(TrashIcon)
                                        ),
                                        React.createElement('button', { onClick: (e) => { e.stopPropagation(); onStartWorkout(plan); }, disabled: !!editingPlanId, className: 'px-4 py-2 text-sm font-semibold text-white bg-green-600 rounded-lg shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50' },
                                            'Inizia'
                                        )
                                    )
                                ),
                                isExpanded && (
                                    React.createElement('div', { className: 'pb-4 px-4 pl-12 space-y-3' },
                                        React.createElement('ul', { className: 'space-y-2 border-l-2 border-gray-200 dark:border-gray-700 pl-4' },
                                            plan.exercises.map((exercise, index) => {
                                                let supersetLabel = '';
                                                if (exercise.supersetKey) {
                                                    const firstIndexOfSuperset = plan.exercises.findIndex(e => e.supersetKey === exercise.supersetKey);
                                                    const supersetNumber = index - firstIndexOfSuperset + 1;
                                                    supersetLabel = `${exercise.supersetKey}${supersetNumber}`;
                                                }
                                                return React.createElement('li', { key: index, className: 'text-sm' },
                                                    React.createElement('p', { className: 'font-semibold text-gray-800 dark:text-white flex items-center gap-2' },
                                                        supersetLabel && React.createElement('span', { className: 'inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300' }, supersetLabel),
                                                        React.createElement('span', null, exercise.name)
                                                    ),
                                                    React.createElement('p', { className: 'text-xs text-gray-500 dark:text-gray-400 ml-1' },
                                                        `${exercise.targetSets} serie × ${exercise.targetReps} rip • ${exercise.restTime}s recupero`
                                                    )
                                                );
                                            })
                                        )
                                    )
                                )
                            )
                        })
                    )
                ) : (
                    React.createElement('div', { className: 'text-center py-10 px-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg mt-6' },
                        React.createElement(SparklesIcon, { className: 'mx-auto h-12 w-12 text-gray-400' }),
                        React.createElement('h3', { className: 'mt-2 text-lg font-medium text-gray-900 dark:text-white' }, 'Nessun piano di allenamento'),
                        React.createElement('p', { className: 'mt-1 text-sm text-gray-500 dark:text-gray-400' }, "Crea il tuo primo piano usando l'IA qui sopra.")
                    )
                )
            )
        );
    };

    const HistoryPage = ({ sessions }) => {
        const completedSessions = sessions
            .filter(session => session.endTime)
            .sort((a, b) => b.startTime - a.startTime);

        const formatDate = (timestamp) => {
            return new Date(timestamp).toLocaleDateString('it-IT', {
                year: 'numeric', month: 'long', day: 'numeric',
            });
        };

        const formatDuration = (startTime, endTime) => {
            if (!endTime) return 'In corso';
            const durationSeconds = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(durationSeconds / 60);
            const seconds = durationSeconds % 60;
            if (minutes === 0 && seconds === 0) return '< 1s';
            if (minutes === 0) return `${seconds}s`;
            return `${minutes}m ${seconds}s`;
        };

        return React.createElement('div', { className: 'space-y-6' },
            React.createElement('h1', { className: 'text-3xl font-bold text-gray-800 dark:text-white' }, 'Diario Allenamenti'),
            completedSessions.length > 0 ? (
                React.createElement('ul', { className: 'space-y-4' },
                    completedSessions.map(session => (
                        React.createElement('li', { key: session.id, className: 'bg-white dark:bg-gray-800 rounded-xl shadow p-4 flex flex-col items-center space-y-2 transition-shadow hover:shadow-md' },
                            React.createElement('div', { className: 'p-2 bg-gray-100 dark:bg-gray-700 rounded-full' }, React.createElement(ClockIcon)),
                            React.createElement('div', { className: 'text-center' },
                                React.createElement('p', { className: 'font-bold text-gray-800 dark:text-white' }, session.planName),
                                React.createElement('p', { className: 'text-sm text-gray-500 dark:text-gray-400' }, formatDate(session.startTime))
                            ),
                            React.createElement('div', { className: 'text-center mt-1' },
                                React.createElement('p', { className: 'text-xs font-semibold text-gray-700 dark:text-gray-300' }, 'Durata'),
                                React.createElement('p', { className: 'text-sm text-gray-500 dark:text-gray-400' }, formatDuration(session.startTime, session.endTime))
                            )
                        )
                    ))
                )
            ) : (
                React.createElement('div', { className: 'text-center py-10 px-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg mt-6' },
                    React.createElement(BookOpenIcon, { className: 'mx-auto h-12 w-12 text-gray-400' }),
                    React.createElement('h3', { className: 'mt-2 text-lg font-medium text-gray-900 dark:text-white' }, 'Nessun allenamento completato'),
                    React.createElement('p', { className: 'mt-1 text-sm text-gray-500 dark:text-gray-400' }, 'Completa un allenamento per vederlo registrato nel tuo diario.')
                )
            )
        );
    };

    const BottomNavBar = ({ activeView, setActiveView }) => {
        const navItems = [
            { id: 'dashboard', label: 'AI Coach', icon: SparklesIcon },
            { id: 'builder', label: 'Crea', icon: DocumentAddIcon },
            { id: 'history', label: 'Diario', icon: BookOpenIcon },
        ];

        return React.createElement('nav', { className: 'fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700' },
            React.createElement('div', { className: 'max-w-2xl mx-auto flex justify-around' },
                navItems.map(item => {
                    const isActive = activeView === item.id;
                    const activeColor = 'text-blue-600 dark:text-blue-400';
                    const inactiveColor = 'text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-300';
                    return React.createElement('button', {
                        key: item.id,
                        onClick: () => setActiveView(item.id),
                        className: `flex flex-col items-center justify-center w-full pt-2 pb-1 transition-colors ${isActive ? activeColor : inactiveColor}`
                    },
                        React.createElement(item.icon, { className: 'h-6 w-6 mb-1' }),
                        React.createElement('span', { className: 'text-xs font-medium' }, item.label)
                    );
                })
            )
        );
    };

    const ExerciseDetailModal = ({ exercise, onClose }) => {
        if (!exercise) return null;

        return React.createElement('div', { 
            className: 'fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50',
            onClick: onClose
        },
            React.createElement('div', { 
                className: 'bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto',
                onClick: e => e.stopPropagation()
            },
                React.createElement('div', { className: 'p-4 border-b dark:border-gray-700 flex justify-between items-center' },
                    React.createElement('h3', { className: 'text-xl font-bold text-gray-800 dark:text-white' }, exercise.name),
                    React.createElement('button', { onClick: onClose, className: 'p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700' }, React.createElement(XIcon, { className: 'h-5 w-5' }))
                ),
                React.createElement('div', { className: 'p-4 space-y-4' },
                    React.createElement('img', { src: exercise.gif_url, alt: `Animazione per ${exercise.name}`, className: 'w-full rounded-lg bg-gray-200 dark:bg-gray-700' }),
                    React.createElement('p', { className: 'text-gray-600 dark:text-gray-300' }, exercise.description),
                    React.createElement('div', null,
                        React.createElement('h4', { className: 'font-semibold text-gray-700 dark:text-gray-200' }, 'Muscoli Primari'),
                        React.createElement('p', { className: 'text-sm text-gray-500 dark:text-gray-400' }, exercise.muscles_primary.join(', '))
                    ),
                    React.createElement('div', null,
                        React.createElement('h4', { className: 'font-semibold text-gray-700 dark:text-gray-200' }, 'Muscoli Secondari'),
                        React.createElement('p', { className: 'text-sm text-gray-500 dark:text-gray-400' }, exercise.muscles_secondary.join(', '))
                    )
                )
            )
        );
    };

    const WorkoutView = ({ session, sessions, onSessionUpdate, onFinish }) => {
        const REST_TIMER_KEY_PREFIX = 'gym-pal-ai-rest-timer-';
        const NOTIFICATION_SOUND = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//tAnxAAAAAAAAAAAAAAAAAAAAAAAAB9/29fAAAAAEDECDSBAAANaAASHCBAgghV1c4BwQAAFBBRUBIRoUCAwEBgQFERMcHCIlBwgQAAAAAAAAAAAAAAD/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXVf/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1f/8ECpQYGAAGW0bAACEUAAAY2BsAADGcADG0AAxsbGxsTE9PTVFRcXF1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1';

        const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
        const [isResting, setIsResting] = useState(false);
        const [restTimer, setRestTimer] = useState(0);
        const [isEditingExerciseName, setIsEditingExerciseName] = useState(false);
        const [editingExerciseNameValue, setEditingExerciseNameValue] = useState('');
        const [exerciseModalData, setExerciseModalData] = useState(null);
        const [lastPerformance, setLastPerformance] = useState(null);

        const inputsRef = useRef([]);
        const audioRef = useRef(null);
        const editExerciseInputRef = useRef(null);

        const currentExercise = session.exercises[currentExerciseIndex];
        const isWorkoutComplete = session.exercises.every(ex => ex.sets.every(s => s.completed));

        useEffect(() => {
            // Find the last performance for the current exercise
            const findLastPerformance = (exerciseName) => {
                const relevantSessions = sessions
                    .filter(s => s.endTime && s.planId === session.planId)
                    .sort((a, b) => b.startTime - a.startTime);

                for (const s of relevantSessions) {
                    const performedExercise = s.exercises.find(ex => ex.name === exerciseName);
                    if (performedExercise) {
                        return performedExercise;
                    }
                }
                return null;
            };
            setLastPerformance(findLastPerformance(currentExercise.name));
        }, [currentExercise.name, sessions, session.planId]);

        useEffect(() => {
            if (isEditingExerciseName && editExerciseInputRef.current) {
                editExerciseInputRef.current.focus();
                editExerciseInputRef.current.select();
            }
        }, [isEditingExerciseName]);

        const handleSessionChange = useCallback((updatedSession) => {
            onSessionUpdate(updatedSession);
        }, [onSessionUpdate]);

        const playSound = useCallback(() => {
            audioRef.current?.play().catch(e => console.error("Audio playback failed:", e));
        }, []);

        const findNextInSuperset = useCallback((currentIndex) => {
            const currentEx = session.exercises[currentIndex];
            if (!currentEx?.supersetKey) return -1;
            for (let i = currentIndex + 1; i < session.exercises.length; i++) {
                const nextEx = session.exercises[i];
                if (nextEx.supersetKey === currentEx.supersetKey) {
                     if (!nextEx.sets.every(s => s.completed)) {
                        return i;
                    }
                } else {
                    return -1;
                }
            }
            return -1;
        }, [session.exercises]);

        const isLastInSuperset = useCallback((currentIndex) => {
            return findNextInSuperset(currentIndex) === -1;
        }, [findNextInSuperset]);

        const handleNextExercise = useCallback(() => {
            const nextIndex = session.exercises.findIndex((ex, idx) => idx > currentExerciseIndex && !ex.sets.every(s => s.completed));
            if (nextIndex !== -1) {
                setCurrentExerciseIndex(nextIndex);
            }
        }, [currentExerciseIndex, session.exercises]);

        const handlePrevExercise = () => {
            if (currentExerciseIndex > 0) {
                setCurrentExerciseIndex(prev => prev - 1);
            }
        };
        
        const startRestTimer = useCallback((duration, isInterExercise = false) => {
            const timerEndTime = Date.now() + duration * 1000;
            localStorage.setItem(`${REST_TIMER_KEY_PREFIX}${session.id}`, JSON.stringify({
                endTime: timerEndTime,
                isInterExercise: isInterExercise
            }));
            setIsResting(true);
            setRestTimer(duration);
        }, [session.id]);
        
        const handleSkipRest = useCallback(() => {
            const timerDataJSON = localStorage.getItem(`${REST_TIMER_KEY_PREFIX}${session.id}`);
            setIsResting(false);
            setRestTimer(0);
            
            if (timerDataJSON) {
                const timerData = JSON.parse(timerDataJSON);
                localStorage.removeItem(`${REST_TIMER_KEY_PREFIX}${session.id}`);
                if (timerData.isInterExercise) {
                    handleNextExercise();
                }
            }
        }, [session.id, handleNextExercise]);

        useEffect(() => {
            let interval = null;
            if (isResting) {
                interval = window.setInterval(() => {
                    const timerDataJSON = localStorage.getItem(`${REST_TIMER_KEY_PREFIX}${session.id}`);
                    if (!timerDataJSON) {
                        setIsResting(false);
                        if (interval) clearInterval(interval);
                        return;
                    }
                    
                    const timerData = JSON.parse(timerDataJSON);
                    const remainingTime = Math.round((timerData.endTime - Date.now()) / 1000);

                    if (remainingTime > 0) {
                        setRestTimer(remainingTime);
                    } else {
                        setRestTimer(0);
                        setIsResting(false);
                        playSound();
                        localStorage.removeItem(`${REST_TIMER_KEY_PREFIX}${session.id}`);
                        if (timerData.isInterExercise) {
                            handleNextExercise();
                        }
                        if (interval) clearInterval(interval);
                    }
                }, 1000);
            }
            return () => {
                if (interval) clearInterval(interval);
            };
        }, [isResting, session.id, playSound, handleNextExercise]);
        
        useEffect(() => {
            const savedTimerDataJSON = localStorage.getItem(`${REST_TIMER_KEY_PREFIX}${session.id}`);
            if (savedTimerDataJSON) {
                const savedTimerData = JSON.parse(savedTimerDataJSON);
                if (savedTimerData.endTime > Date.now()) {
                    const remainingTime = Math.round((savedTimerData.endTime - Date.now()) / 1000);
                    setRestTimer(remainingTime);
                    setIsResting(true);
                } else {
                    localStorage.removeItem(`${REST_TIMER_KEY_PREFIX}${session.id}`);
                    if (savedTimerData.isInterExercise) {
                       handleNextExercise();
                    }
                }
            }
        }, [session.id, handleNextExercise]);
        
        const handleSetCompletion = (setIndex) => {
            const isNowCompleted = !currentExercise.sets[setIndex].completed;
            const newSession = {
                ...session,
                exercises: session.exercises.map((ex, exIndex) => {
                    if (exIndex !== currentExerciseIndex) return ex;
                    return {
                        ...ex,
                        sets: ex.sets.map((s, sIndex) => {
                            if (sIndex !== setIndex) return s;
                            return { ...s, completed: isNowCompleted };
                        })
                    };
                })
            };
            handleSessionChange(newSession);

            if (isNowCompleted) {
                const updatedExercise = newSession.exercises[currentExerciseIndex];
                const areAllSetsForCurrentExerciseComplete = updatedExercise.sets.every(s => s.completed);

                if (areAllSetsForCurrentExerciseComplete) {
                    const isLastInGroup = isLastInSuperset(currentExerciseIndex);
                    if (isLastInGroup) {
                        const nextOverallExerciseIndex = session.exercises.findIndex((ex, idx) => idx > currentExerciseIndex);
                        if (nextOverallExerciseIndex !== -1) {
                            startRestTimer(60, true);
                        }
                    }
                } else {
                    startRestTimer(currentExercise.restTime, false);
                }
            }
        };

        const handleSetInputChange = (setIndex, field, value) => {
            const numValue = value === '' ? null : parseInt(value, 10);
            const newSession = {
                ...session,
                exercises: session.exercises.map((ex, exIndex) => {
                    if (exIndex !== currentExerciseIndex) return ex;
                    return {
                        ...ex,
                        sets: ex.sets.map((s, sIndex) => {
                            if (sIndex !== setIndex) return s;
                            return {
                                ...s,
                                [field]: isNaN(numValue) ? null : numValue
                            };
                        })
                    };
                })
            };
            handleSessionChange(newSession);
        };

        const handleAddSet = () => {
            const newSession = {
                ...session,
                exercises: session.exercises.map((ex, exIndex) => {
                    if (exIndex !== currentExerciseIndex) return ex;
                    const newSet = {
                        id: `set_dyn_${Date.now()}`,
                        reps: null,
                        weight: null,
                        completed: false,
                    };
                    return { ...ex, sets: [...ex.sets, newSet] };
                })
            };
            handleSessionChange(newSession);
        };

        const handleRemoveSet = () => {
            if (currentExercise.sets.length <= 1) return;
            const newSession = {
                ...session,
                exercises: session.exercises.map((ex, exIndex) => {
                    if (exIndex !== currentExerciseIndex) return ex;
                    return { ...ex, sets: ex.sets.slice(0, -1) };
                })
            };
            handleSessionChange(newSession);
        };
        
        const handleStartEditingExerciseName = () => {
            setIsEditingExerciseName(true);
            setEditingExerciseNameValue(currentExercise.name);
        };
    
        const handleSaveExerciseName = () => {
            if (!editingExerciseNameValue.trim()) {
                setIsEditingExerciseName(false);
                return;
            }
            const newSession = {
                ...session,
                exercises: session.exercises.map((ex, exIndex) => {
                    if (exIndex !== currentExerciseIndex) return ex;
                    return { ...ex, name: editingExerciseNameValue.trim() };
                })
            };
            handleSessionChange(newSession);
            setIsEditingExerciseName(false);
        };
        
        const handleOpenExerciseModal = () => {
            const key = currentExercise.name.toLowerCase().trim();
            if (EXERCISE_LIBRARY[key]) {
                setExerciseModalData(EXERCISE_LIBRARY[key]);
            }
        };

        useEffect(() => {
            const handleKeyDown = (event) => {
                if (event.key === 'Escape') {
                    if (isEditingExerciseName) setIsEditingExerciseName(false);
                    if (exerciseModalData) setExerciseModalData(null);
                }
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [isEditingExerciseName, exerciseModalData]);

        const nextSupersetExerciseIndex = findNextInSuperset(currentExerciseIndex);
        const areAllSetsForCurrentExerciseDone = currentExercise.sets.every(s => s.completed);
        const isSupersetTransition = areAllSetsForCurrentExerciseDone && nextSupersetExerciseIndex !== -1;

        return React.createElement('div', { className: 'relative pb-32' },
            React.createElement(ExerciseDetailModal, { exercise: exerciseModalData, onClose: () => setExerciseModalData(null) }),
            React.createElement('audio', { ref: audioRef, src: NOTIFICATION_SOUND, preload: 'auto' }),
            React.createElement('header', { className: 'flex justify-between items-center mb-4' },
                React.createElement('button', { onClick: onFinish, className: 'text-sm text-blue-600 dark:text-blue-400 hover:underline' },
                    '← Torna alla Dashboard'
                ),
                 React.createElement('div', { className: 'flex items-center gap-2' },
                    React.createElement('select', {
                        value: currentExerciseIndex,
                        onChange: e => {
                            setIsResting(false);
                            setRestTimer(0);
                            localStorage.removeItem(`${REST_TIMER_KEY_PREFIX}${session.id}`);
                            setCurrentExerciseIndex(parseInt(e.target.value, 10));
                        },
                        className: `bg-transparent text-sm p-1 rounded-md border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none max-w-[120px] sm:max-w-xs truncate ${currentExercise.sets.every(s => s.completed) ? 'text-green-600 dark:text-green-500' : 'text-gray-800 dark:text-gray-200'}`,
                        'aria-label': 'Seleziona esercizio'
                    },
                        session.exercises.map((exercise, index) => {
                            const isCompleted = exercise.sets.every(s => s.completed);
                            const optionClassName = `bg-white dark:bg-gray-800 ${isCompleted ? 'text-green-600 dark:text-green-500' : 'text-gray-900 dark:text-gray-100'}`;
                            return React.createElement('option', { 
                                key: exercise.id, 
                                value: index,
                                className: optionClassName
                             },
                                `${isCompleted ? '✓ ' : ''}${index + 1}. ${exercise.name}`
                            );
                        })
                    ),
                    React.createElement('span', { className: 'text-sm text-gray-500 dark:text-gray-400' }, `/ ${session.exercises.length}`)
                )
            ),
            React.createElement('div', { className: 'bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 space-y-4' },
                React.createElement('div', { className: 'flex items-center gap-2' },
                    isEditingExerciseName ? (
                        React.createElement('input', {
                            ref: editExerciseInputRef,
                            type: 'text',
                            value: editingExerciseNameValue,
                            onChange: (e) => setEditingExerciseNameValue(e.target.value),
                            onBlur: handleSaveExerciseName,
                            onKeyDown: (e) => e.key === 'Enter' && handleSaveExerciseName(),
                            className: 'text-2xl sm:text-3xl font-bold text-gray-800 dark:text-white bg-gray-100 dark:bg-gray-700 rounded p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow'
                        })
                    ) : (
                        React.createElement('button', { onClick: handleOpenExerciseModal, className: 'text-left w-full' },
                            React.createElement('h2', { className: 'text-2xl sm:text-3xl font-bold text-gray-800 dark:text-white truncate hover:text-blue-600 dark:hover:text-blue-400', title: currentExercise.name },
                                currentExercise.name
                            )
                        )
                    ),
                    React.createElement('button', { onClick: handleStartEditingExerciseName, className: 'p-1 text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 transition-colors flex-shrink-0', 'aria-label': `Sostituisci esercizio ${currentExercise.name}` },
                        React.createElement(SwitchHorizontalIcon, { className: 'h-5 w-5' })
                    )
                ),
                React.createElement('div', { className: 'grid grid-cols-4 text-center gap-2 text-sm text-gray-500 dark:text-gray-400 items-center' },
                    React.createElement('div', null, React.createElement('span', { className: 'font-semibold' }, currentExercise.sets.length), ' Serie'),
                    React.createElement('div', null, React.createElement('span', { className: 'font-semibold' }, currentExercise.targetReps), ' Rip'),
                    React.createElement('div', null, React.createElement('span', { className: 'font-semibold' }, currentExercise.restTime, 's'), ' Recupero'),
                    React.createElement('div', { className: 'flex justify-center gap-2' },
                        React.createElement('button', { onClick: handleRemoveSet, disabled: currentExercise.sets.length <= 1, className: 'text-gray-400 hover:text-red-500 disabled:opacity-30 disabled:cursor-not-allowed' }, React.createElement(MinusCircleIcon, { className: 'h-6 w-6' })),
                        React.createElement('button', { onClick: handleAddSet, className: 'text-gray-400 hover:text-green-500' }, React.createElement(PlusCircleIcon, { className: 'h-6 w-6' }))
                    )
                ),
                currentExercise.description && React.createElement('p', { className: 'text-sm text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 p-3 rounded-lg' }, currentExercise.description),
                React.createElement('div', { className: 'space-y-3 pt-2' },
                    React.createElement('div', { className: 'grid grid-cols-12 gap-2 text-xs font-semibold text-gray-500 dark:text-gray-400 px-2' },
                        React.createElement('div', { className: 'col-span-1 text-center' }, 'Serie'),
                        React.createElement('div', { className: 'col-span-4 text-center' }, 'Precedente'),
                        React.createElement('div', { className: 'col-span-3 text-center' }, 'Rip'),
                        React.createElement('div', { className: 'col-span-3 text-center' }, 'Peso (kg)'),
                        React.createElement('div', { className: 'col-span-1 text-center' }, '✓')
                    ),
                    currentExercise.sets.map((set, setIndex) => {
                        const lastSet = lastPerformance?.sets[setIndex];
                        return React.createElement('div', { key: set.id, className: `grid grid-cols-12 gap-2 items-center p-2 rounded-lg transition-colors ${set.completed ? 'bg-green-100 dark:bg-green-900/50' : 'bg-gray-100 dark:bg-gray-700/60'}` },
                            React.createElement('div', { className: 'col-span-1 text-center font-bold text-lg text-gray-700 dark:text-gray-300' }, setIndex + 1),
                            React.createElement('div', { className: 'col-span-4 text-center text-xs text-gray-500 dark:text-gray-400' },
                                lastSet ? `${lastSet.reps ?? '--'} rip @ ${lastSet.weight ?? '--'} kg` : 'N/A'
                            ),
                            React.createElement('div', { className: 'col-span-3' },
                                React.createElement('input', { ref: el => { inputsRef.current[setIndex * 2] = el; }, type: 'number', inputMode: 'numeric', placeholder: currentExercise.targetReps, value: set.reps ?? '', onChange: e => handleSetInputChange(setIndex, 'reps', e.target.value), className: 'w-full text-center bg-white dark:bg-gray-800 rounded-md p-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none' })
                            ),
                            React.createElement('div', { className: 'col-span-3' },
                                React.createElement('input', { ref: el => { inputsRef.current[setIndex * 2 + 1] = el; }, type: 'number', inputMode: 'numeric', placeholder: '--', value: set.weight ?? '', onChange: e => handleSetInputChange(setIndex, 'weight', e.target.value), className: 'w-full text-center bg-white dark:bg-gray-800 rounded-md p-2 shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none' })
                            ),
                            React.createElement('div', { className: 'col-span-1 flex justify-center' },
                                React.createElement('button', { onClick: () => handleSetCompletion(setIndex), className: `w-7 h-7 rounded-full flex items-center justify-center transition-all ${set.completed ? 'bg-green-500 text-white shadow-sm' : 'bg-white dark:bg-gray-600 border border-gray-300 dark:border-gray-500 text-gray-300 dark:text-gray-500'}`, 'aria-label': `Segna la serie ${setIndex + 1} come ${set.completed ? 'incompleta' : 'completa'}` },
                                    React.createElement(CheckIcon, { className: 'h-4 w-4' })
                                )
                            )
                        )
                    })
                )
            ),
            React.createElement('div', { className: 'fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm p-4 border-t border-gray-200 dark:border-gray-700' },
                React.createElement('div', { className: 'max-w-2xl mx-auto flex justify-between items-center' },
                    React.createElement('button', { onClick: handlePrevExercise, disabled: currentExerciseIndex === 0 || isResting, className: 'p-3 bg-gray-200 dark:bg-gray-700 rounded-full disabled:opacity-40 disabled:cursor-not-allowed', 'aria-label': 'Esercizio Precedente' },
                        React.createElement(ChevronLeftIcon)
                    ),
                    isSupersetTransition ? (
                        React.createElement('button', { onClick: () => setCurrentExerciseIndex(nextSupersetExerciseIndex), className: 'px-5 py-3 text-md font-semibold text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700' },
                            'Prossimo nel Superset →'
                        )
                    ) : isWorkoutComplete ? (
                        React.createElement('button', { onClick: onFinish, className: 'px-6 py-3 text-lg font-bold text-white bg-green-600 rounded-lg shadow-lg hover:bg-green-700 transform hover:scale-105 transition-transform' },
                            'Termina Allenamento!'
                        )
                    ) : isResting ? (
                        React.createElement('div', { className: 'flex items-center gap-4' },
                            React.createElement('div', { className: 'flex flex-col items-center' },
                                React.createElement('span', { className: 'text-sm font-semibold text-gray-500 dark:text-gray-400' }, 'RECUPERO'),
                                React.createElement('span', { className: 'text-3xl font-bold text-blue-600 dark:text-blue-400' }, `${String(Math.floor(restTimer / 60)).padStart(2, '0')}:${String(restTimer % 60).padStart(2, '0')}`)
                            ),
                            React.createElement('button', { onClick: handleSkipRest, className: 'px-4 py-1 text-sm font-semibold text-blue-600 bg-blue-100 dark:bg-blue-900/50 dark:text-blue-300 rounded-full hover:bg-blue-200' }, 'Salta')
                        )
                    ) : (
                        React.createElement('button', { onClick: onFinish, className: 'px-5 py-3 text-md font-semibold text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600' },
                            'Termina Dopo'
                        )
                    ),
                    React.createElement('button', { onClick: handleNextExercise, disabled: currentExerciseIndex >= session.exercises.length - 1 || isResting || isSupersetTransition, className: 'p-3 bg-gray-200 dark:bg-gray-700 rounded-full disabled:opacity-40 disabled:cursor-not-allowed', 'aria-label': 'Esercizio Successivo' },
                        React.createElement(ChevronRightIcon)
                    )
                )
            )
        );
    };

    // ===== APP ROOT =====
    const App = () => {
        const ACTIVE_SESSION_ID_KEY = 'gym-pal-ai-active-session-id';
        const { plans, sessions, addPlan, updatePlan, deletePlan, startWorkoutSession, updateWorkoutSession, getSessionById, loading } = useWorkoutStore();
        const [activeSessionId, setActiveSessionId] = useState(null);
        const [activeView, setActiveView] = useState('dashboard');

        useEffect(() => {
            if (!loading) {
                const lastSessionId = localStorage.getItem(ACTIVE_SESSION_ID_KEY);
                if (lastSessionId) {
                    const sessionToResume = sessions.find(s => s.id === lastSessionId);
                    if (sessionToResume && !sessionToResume.endTime) {
                        setActiveSessionId(lastSessionId);
                    } else {
                        localStorage.removeItem(ACTIVE_SESSION_ID_KEY);
                    }
                }
            }
        }, [loading, sessions]);

        useEffect(() => {
            if (activeSessionId) {
                localStorage.setItem(ACTIVE_SESSION_ID_KEY, activeSessionId);
            } else {
                localStorage.removeItem(ACTIVE_SESSION_ID_KEY);
            }
        }, [activeSessionId]);


        const handleStartWorkout = useCallback((plan) => {
            const newSession = startWorkoutSession(plan);
            setActiveSessionId(newSession.id);
        }, [startWorkoutSession]);

        const handleFinishWorkout = useCallback(() => {
            if (activeSessionId) {
                const session = getSessionById(activeSessionId);
                if (session) {
                    const finishedSession = { ...session, endTime: Date.now() };
                    updateWorkoutSession(finishedSession);
                }
            }
            setActiveSessionId(null);
            setActiveView('history');
        }, [activeSessionId, getSessionById, updateWorkoutSession]);

        const activeSession = activeSessionId ? getSessionById(activeSessionId) : null;

        const renderActiveView = () => {
            switch (activeView) {
                case 'dashboard':
                    return React.createElement(Dashboard, { 
                        plans: plans,
                        onAddPlan: addPlan,
                        onUpdatePlan: updatePlan,
                        onDeletePlan: deletePlan,
                        onStartWorkout: handleStartWorkout
                    });
                case 'builder':
                    return React.createElement(ManualPlanBuilder, {
                        onPlanAdded: (plan) => {
                            addPlan(plan);
                            setActiveView('dashboard');
                        }
                    });
                case 'history':
                    return React.createElement(HistoryPage, { sessions: sessions });
                default:
                    return React.createElement(Dashboard, { plans: plans, onAddPlan: addPlan, onUpdatePlan: updatePlan, onDeletePlan: deletePlan, onStartWorkout: handleStartWorkout });
            }
        };

        if (loading) {
            return React.createElement('div', { className: "flex items-center justify-center h-screen bg-gray-50 dark:bg-gray-900" }, React.createElement(Spinner));
        }
        
        return React.createElement('div', { className: "min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100" },
            React.createElement('main', { className: "max-w-2xl mx-auto p-4 sm:p-6 pb-24" },
                activeSession ? (
                    React.createElement(WorkoutView, { 
                        session: activeSession,
                        sessions: sessions,
                        onSessionUpdate: updateWorkoutSession,
                        onFinish: handleFinishWorkout
                    })
                ) : renderActiveView()
            ),
            !activeSession && React.createElement(BottomNavBar, { activeView, setActiveView })
        );
    };

    // ===== RENDER =====
    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(React.createElement(React.StrictMode, null, React.createElement(App)));

  </script>
</body>
</html>